---
title: "Random Forest viruses"
author: "Regino Barranquero Cardeñosa"
date: "2023-06-28"
output:
  html_document:
    toc: yes
    theme: united
    toc_float: true
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
rm(list = ls())
library(readxl)
library(tidyverse)
library(astsa)
library(patchwork)
library(lubridate)
library(reactable)
library(bnlearn)
library(bnviewer)
library(randomForest)
library(Boruta)
library(GGally)
library(NMOF)
library(party)
library(ggraph)
library(igraph)
```

# Datos

```{r echo=FALSE, message=FALSE, warning=FALSE}
datos <- read_excel("datos_regino_ingles_ACTUALIZADO.xlsx", skip = 10, na = 'No data')[1:69, ]
datos %>% reactable(searchable = TRUE, 
                    striped = TRUE, 
                    highlight = TRUE, 
                    bordered = TRUE, 
                    defaultColDef = colDef(format = colFormat(digits = 3)), 
                    theme = reactableTheme(borderColor = "#dfe2e5", 
                                           stripedColor = "#f6f8fa", 
                                           highlightColor = "#f0f5f9", 
                                           style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                           searchInputStyle = list(width = "100%")))
```

```{r echo=FALSE}
influenza <- datos[, 1:4]
names(influenza) <- str_split_i(names(influenza), '\\.', 1)

rsv <- datos[, 6:8]
names(rsv) <- str_split_i(names(rsv), '\\.', 1)

covid <- datos[, 10:12]
names(covid) <- str_split_i(names(covid), '\\.', 1)

normdata <- datos[, c(14:20, 22:24)]
names(normdata) <- str_split_i(names(normdata), '\\.', 1)
#normdata$`Nitrógeno total (mg/L)`[48] <- normdata$`Nitrógeno total (mg/L)`[48] / 10.0
```

# Influenza

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
aux <- influenza %>% 
    cbind(normdata) %>% 
    select(-Sample, -Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`IAV (gc/L)`})
names(datos) <- paste('IAV (gc/L) *', names(datos))

completos <- cbind(aux, datos[, 3:12])

normalizados <- cbind(aux[, 1:2], datos[, 3:12])

normalizadoslag1 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag1[, 2:12] <- lag(normalizadoslag1[, 2:12] , n = 1)
names(normalizadoslag1)[2:12] <- paste(names(normalizadoslag1)[2:12], '(lag 1)')
normalizadoslag1juntos <- cbind(normalizados, normalizadoslag1[, 2:12])
completoslag1 <- cbind(completos, lag(completos[, 2:22], n = 1))
names(completoslag1)[23:43] <- paste(names(completoslag1)[23:43], '(lag 1)')

normalizadoslag2 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag2[, 2:12] <- lag(normalizadoslag2[, 2:12] , n = 2)
names(normalizadoslag2)[2:12] <- paste(names(normalizadoslag2)[2:12], '(lag 2)')
normalizadoslag2juntos <- cbind(normalizados, normalizadoslag2[, 2:12])
completoslag2 <- cbind(completos, lag(completos[, 2:22], n = 2))
names(completoslag2)[23:43] <- paste(names(completoslag2)[23:43], '(lag 2)')

completoslag1y2 <- cbind(completoslag1, completoslag2[, 23:43])

aux <- influenza %>% 
    cbind(normdata) %>% 
    select(-Sample, -Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`IAV (gc/L)`})
names(datos) <- paste('IAV (gc/L) *', names(datos))
aux <- cbind(aux, datos[, 3:12])
aux2 <- cbind(aux[, 1:2], datos[, 3:12])
# ------------------------------------------------------------------------------
# Correlations
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_cor.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_pvalues.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_cor_pvalues.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_cor2.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_pvalues2.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of Influenza clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/IAV_cor_pvalues2.pdf', device = 'pdf', width = 12, height = 6, dpi = 320)
```

Valores negativos de delay significan Weeks siguientes a la Week correspondiente de los casos clínicos, por ejemplo, delay -1 significa casos clínicos Week 1 correlacionados con los demás datos de la Week 2. Valores positivos lo contrario, correlaciones de los casos clínicos con los datos de las demás variables en las Weeks anteriores, por ejemplo, delay 1 son las correlaciones de los datos clínicos de la Week 2 con los demás datos en la Week 1.

Los delays negativos servirían para ver si hay una correlación (o se produce un efecto, aunque correlación no significa causa) entre las variables medidas en las aguas residuales después de los casos clínicos detectados, como si el virus dejase un rastro a posteriori. Los delays positivos son el caso contrario, ver correlación con Weeks previas, como si intentásemos ver si hay evidencia del virus en las aguas residuales antes de que se contabilicen los casos clínicos.

```{r echo=FALSE, fig.height=18, fig.width=18, message=FALSE, warning=FALSE}
set.seed(666)
test_1 <- sample(1:69, 29)
test_2 <- sample(1:69, 29)
test_3 <- sample(1:69, 29)
test_4 <- sample(1:69, 29)
test_5 <- sample(1:69, 29)
aux <- aux %>% mutate(test1 = 1:69 %in% test_1, 
                      test2 = 1:69 %in% test_2, 
                      test3 = 1:69 %in% test_3, 
                      test4 = 1:69 %in% test_4, 
                      test5 = 1:69 %in% test_5)

ggpairs(completos[, c(1:12)] %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalisation variables')
ggsave('./plots/IAV_ggpairs.pdf', device = 'pdf', width = 18, height = 18, dpi = 320)

ggpairs(normalizados %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised level')
ggsave('./plots/IAV_ggpairs2.pdf', device = 'pdf', width = 18, height = 18, dpi = 320)

ggpairs(normalizadoslag1 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 1 week lagged level')
ggsave('./plots/IAV_ggpairs3.pdf', device = 'pdf', width = 18, height = 18, dpi = 320)

ggpairs(normalizadoslag2 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 2 week lagged level')
ggsave('./plots/IAV_ggpairs4.pdf', device = 'pdf', width = 18, height = 18, dpi = 320)
```

He separado los datos en dos conjuntos (entrenamiento y test) para ajustar los modelos y poder tener una medida en test con las que comparar desempeños. He separado 40 puntos para entrenamiento y 29 para test. Las distribuciones cambian levemente como se puede ver en los histogramas (cambia la mediana y poco más) lo que puede provocar diferencias en los modelos entre los resultados en entrenamiento y test, aunque no serán muy graves ya que las diferencias son leves. Lo ideal es que los dos conjuntos tengan exactamente la misma distribución de los datos, cosa complicada entre menos datos tengamos, por lo que esta separación es más que suficiente.

Además, para eliminar el efecto del que se habla, he repetido lo mismo 5 veces, dividiendo los datos en dos conjuntos (entrnamiento y test) 5 veces, de manera que las métricas de los modelos son la media de los 5 entrenamientos. Esto se denomina cross-validation y sirve para evitar que las métricas de los modelos dependan de la "suerte" o no al separar los datos en entrenamiento y test.

```{r echo=FALSE, fig.height=15, fig.width=10, message=FALSE, warning=FALSE}
a <- aux %>% 
    mutate(Week = influenza$Week, 
           test1 = ifelse(test1, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test1, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 1') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b <- aux %>% 
    mutate(Week = influenza$Week, 
           test2 = ifelse(test2, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test2, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 2') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c <- aux %>% 
    mutate(Week = influenza$Week, 
           test3 = ifelse(test3, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test3, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 3') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d <- aux %>% 
    mutate(Week = influenza$Week, 
           test4 = ifelse(test4, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test4, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 4') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e <- aux %>% 
    mutate(Week = influenza$Week, 
           test5 = ifelse(test5, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test5, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 5') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a / b / c / d / e
ggsave('./plots/IAV_train_test_split.pdf', device = 'pdf', width = 10, height = 15, dpi = 320)
```

## Todas las variables disponibles

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos1 <- completos
for (i in names(completos1)) {
    completos1[is.na(completos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos1)
#             mae <- ModelMetrics::mae(completos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos2 <- completos
for (i in names(completos2)) {
    completos2[is.na(completos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos2)
#             mae <- c(mae, ModelMetrics::mae(completos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos3 <- completos
for (i in names(completos3)) {
    completos3[is.na(completos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos3)
#             mae <- c(mae, ModelMetrics::mae(completos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos4 <- completos
for (i in names(completos4)) {
    completos4[is.na(completos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos4)
#             mae <- c(mae, ModelMetrics::mae(completos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos5 <- completos
for (i in names(completos5)) {
    completos5[is.na(completos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos5)
#             mae <- c(mae, ModelMetrics::mae(completos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

Se han buscado los mejores parámetros para el Random Forest para cada conjunto de entrenamiento con un Grid Search (básicamente probar todas las combinaciones posibles entre un rango dado) modificando nodesize de 1 a 10, mtry de 1 a 10 y ntree de 10 a 100 en incrementos de 10 y 200, 300, 500, 1000.

Significado de los parámetros:

-   nodesize: Tamaño mínimo de los nodos. Los árboles se construyen diviendiendo en grupos por la variable que sea consecutivamente hasta tener una profundidad determinada. Este parámetro fija el número mínimo de observaciones que tienen que tener esos grupos en los que se van separando los datos. Si una división crea grupos más pequeños que este parámetro, la división no se produce y ese nodo se convierte en nodo "terminal", por lo que este parámetro controla la profundidad de los árboles. Por ejemplo, nodesize = 1 indica que los árboles pueden crecer hasta que los nodos contengan una sola observación cada uno.

-   mtry: Es el número de variables que tiene el algoritmo para elegir cada vez que tiene que crear un nodo. Por ejemplo, mtry = 60 indica que cada vez que va a elegir una variable para hacer una división y separar las observaciones, tiene para elegir entre un conjunto aleatorio de 60 variables del total que haya (en este caso 181).

-   ntree: Es el número de árboles diferentes que va a generar. La predicción final es la clase más votada entre todos estos árboles (en este caso las clases son las diferentes muestras).

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfcom1 <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), y = completos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 10,  ntree = 30)
rfcom1

varImpPlot(rfcom1)

set.seed(42)
rfcom2 <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), y = completos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 10,  ntree = 30)
rfcom2

varImpPlot(rfcom2)

set.seed(42)
rfcom3 <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), y = completos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 10,  ntree = 30)
rfcom3

varImpPlot(rfcom3)

set.seed(42)
rfcom4 <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), y = completos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 10,  ntree = 30)
rfcom4

varImpPlot(rfcom4)

set.seed(42)
rfcom5 <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), y = completos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 10,  ntree = 30)
rfcom5

varImpPlot(rfcom5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_comp_1 <- predict(rfcom1, newdata = completos1)
res_comp_2 <- predict(rfcom2, newdata = completos2)
res_comp_3 <- predict(rfcom3, newdata = completos3)
res_comp_4 <- predict(rfcom4, newdata = completos4)
res_comp_5 <- predict(rfcom5, newdata = completos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomp <- ((importance(rfcom1)[, 'IncNodePurity'] * e1) + 
                (importance(rfcom2)[, 'IncNodePurity'] * e2) + 
                (importance(rfcom3)[, 'IncNodePurity'] * e3) + 
                (importance(rfcom4)[, 'IncNodePurity'] * e4) + 
                (importance(rfcom5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomp <- ((importance(rfcom1)[, '%IncMSE'] * e1) + 
                (importance(rfcom2)[, '%IncMSE'] * e2) + 
                (importance(rfcom3)[, '%IncMSE'] * e3) + 
                (importance(rfcom4)[, '%IncMSE'] * e4) + 
                (importance(rfcom5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomp), `Increase Node Purity` = inpcomp, IAV = names(inpcomp) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomp), `% Increase MSE` = imscomp, IAV = names(imscomp) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_comp.pdf', device = 'pdf', width = 12, height = 5, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
a <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comp_1, 
              `c) RF 2` = res_comp_2, 
              `d) RF 3` = res_comp_3, 
              `e) RF 4` = res_comp_4, 
              `f) RF 5` = res_comp_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a
ggsave('./plots/IAV_res_comp.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comp <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comp_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comp_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comp_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comp_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comp_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comp <- res_comp %>% 
    rbind(c(Data = 'Training %OM', res_comp[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comp[2, -1] / mean(aux$`Clinical cases`))) 

res_comp %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizados %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados1 <- normalizados
for (i in names(normalizados1)) {
    normalizados1[is.na(normalizados1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados1)
#             mae <- ModelMetrics::mae(normalizados1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizados %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados2 <- normalizados
for (i in names(normalizados2)) {
    normalizados2[is.na(normalizados2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados2)
#             mae <- c(mae, ModelMetrics::mae(normalizados2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizados %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados3 <- normalizados
for (i in names(normalizados3)) {
    normalizados3[is.na(normalizados3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados3)
#             mae <- c(mae, ModelMetrics::mae(normalizados3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizados %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados4 <- normalizados
for (i in names(normalizados4)) {
    normalizados4[is.na(normalizados4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados4)
#             mae <- c(mae, ModelMetrics::mae(normalizados4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizados %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados5 <- normalizados
for (i in names(normalizados5)) {
    normalizados5[is.na(normalizados5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados5)
#             mae <- c(mae, ModelMetrics::mae(normalizados5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnorm1 <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
                        y = normalizados1$`Clinical cases`[!aux$test1], importance = T, nodesize = 2, mtry = 7,  ntree = 20)
rfnorm1

varImpPlot(rfnorm1)

set.seed(42)
rfnorm2 <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
                        y = normalizados2$`Clinical cases`[!aux$test2], importance = T, nodesize = 2, mtry = 7,  ntree = 20)
rfnorm2

varImpPlot(rfnorm2)

set.seed(42)
rfnorm3 <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
                        y = normalizados3$`Clinical cases`[!aux$test3], importance = T, nodesize = 2, mtry = 7,  ntree = 20)
rfnorm3

varImpPlot(rfnorm3)

set.seed(42)
rfnorm4 <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
                        y = normalizados4$`Clinical cases`[!aux$test4], importance = T, nodesize = 2, mtry = 7,  ntree = 20)
rfnorm4

varImpPlot(rfnorm4)

set.seed(42)
rfnorm5 <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
                        y = normalizados5$`Clinical cases`[!aux$test5], importance = T, nodesize = 2, mtry = 7,  ntree = 20)
rfnorm5

varImpPlot(rfnorm5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_norm_1 <- predict(rfnorm1, newdata = normalizados1)
res_norm_2 <- predict(rfnorm2, newdata = normalizados2)
res_norm_3 <- predict(rfnorm3, newdata = normalizados3)
res_norm_4 <- predict(rfnorm4, newdata = normalizados4)
res_norm_5 <- predict(rfnorm5, newdata = normalizados5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnorm <- ((importance(rfnorm1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnorm2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnorm3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnorm4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnorm5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnorm <- ((importance(rfnorm1)[, '%IncMSE'] * e1) + 
                (importance(rfnorm2)[, '%IncMSE'] * e2) + 
                (importance(rfnorm3)[, '%IncMSE'] * e3) + 
                (importance(rfnorm4)[, '%IncMSE'] * e4) + 
                (importance(rfnorm5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnorm), `Increase Node Purity` = inpnorm, IAV = names(inpnorm) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnorm), `% Increase MSE` = imsnorm, IAV = names(imsnorm) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_norm.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
b <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_norm_1, 
              `c) RF 2` = res_norm_2, 
              `d) RF 3` = res_norm_3, 
              `e) RF 4` = res_norm_4, 
              `f) RF 5` = res_norm_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b
ggsave('./plots/IAV_res_norm.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_norm <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_norm_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_norm_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_norm_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_norm_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_norm_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_norm <- res_norm %>% 
    rbind(c(Data = 'Training %OM', res_norm[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_norm[2, -1] / mean(aux$`Clinical cases`))) 

res_norm %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag11 <- normalizadoslag1
for (i in names(normalizadoslag11)) {
    normalizadoslag11[is.na(normalizadoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag11)
#             mae <- ModelMetrics::mae(normalizadoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag12 <- normalizadoslag1
for (i in names(normalizadoslag12)) {
    normalizadoslag12[is.na(normalizadoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag12)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag13 <- normalizadoslag1
for (i in names(normalizadoslag13)) {
    normalizadoslag13[is.na(normalizadoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag13)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag14 <- normalizadoslag1
for (i in names(normalizadoslag14)) {
    normalizadoslag14[is.na(normalizadoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag14)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag15 <- normalizadoslag1
for (i in names(normalizadoslag15)) {
    normalizadoslag15[is.na(normalizadoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag15)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag11 <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 7,  ntree = 40)
rfnormlag11

varImpPlot(rfnormlag11)

set.seed(42)
rfnormlag12 <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 7,  ntree = 40)
rfnormlag12

varImpPlot(rfnormlag12)

set.seed(42)
rfnormlag13 <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 7,  ntree = 40)
rfnormlag13

varImpPlot(rfnormlag13)

set.seed(42)
rfnormlag14 <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 7,  ntree = 40)
rfnormlag14

varImpPlot(rfnormlag14)

set.seed(42)
rfnormlag15 <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 7,  ntree = 40)
rfnormlag15

varImpPlot(rfnormlag15)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1_1 <- predict(rfnormlag11, newdata = normalizadoslag11)
res_normlag1_2 <- predict(rfnormlag12, newdata = normalizadoslag12)
res_normlag1_3 <- predict(rfnormlag13, newdata = normalizadoslag13)
res_normlag1_4 <- predict(rfnormlag14, newdata = normalizadoslag14)
res_normlag1_5 <- predict(rfnormlag15, newdata = normalizadoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1 <- ((importance(rfnormlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1 <- ((importance(rfnormlag11)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag12)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag13)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag14)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1), `Increase Node Purity` = inpnormlag1, IAV = names(inpnormlag1) != 'IAV (gc/L) (lag 1)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1), `% Increase MSE` = imsnormlag1, IAV = names(imsnormlag1) != 'IAV (gc/L) (lag 1)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_norm_lag1.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
c <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1_1, 
              `c) RF 2` = res_normlag1_2, 
              `d) RF 3` = res_normlag1_3, 
              `e) RF 4` = res_normlag1_4, 
              `f) RF 5` = res_normlag1_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c
ggsave('./plots/IAV_res_norm_lag1.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1 <- res_normlag1 %>% 
    rbind(c(Data = 'Training %OM', res_normlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos1 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos1)) {
    normalizadoslag1juntos1[is.na(normalizadoslag1juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag1juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos2 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos2)) {
    normalizadoslag1juntos2[is.na(normalizadoslag1juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos3 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos3)) {
    normalizadoslag1juntos3[is.na(normalizadoslag1juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos4 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos4)) {
    normalizadoslag1juntos4[is.na(normalizadoslag1juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos5 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos5)) {
    normalizadoslag1juntos5[is.na(normalizadoslag1juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag1juntos1 <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 2, mtry = 12,  ntree = 30)
rfnormlag1juntos1

varImpPlot(rfnormlag1juntos1)

set.seed(42)
rfnormlag1juntos2 <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 2, mtry = 12,  ntree = 30)
rfnormlag1juntos2

varImpPlot(rfnormlag1juntos2)

set.seed(42)
rfnormlag1juntos3 <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 2, mtry = 12,  ntree = 30)
rfnormlag1juntos3

varImpPlot(rfnormlag1juntos3)

set.seed(42)
rfnormlag1juntos4 <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 2, mtry = 12,  ntree = 30)
rfnormlag1juntos4

varImpPlot(rfnormlag1juntos4)

set.seed(42)
rfnormlag1juntos5 <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 2, mtry = 12,  ntree = 30)
rfnormlag1juntos5

varImpPlot(rfnormlag1juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1juntos_1 <- predict(rfnormlag1juntos1, newdata = normalizadoslag1juntos1)
res_normlag1juntos_2 <- predict(rfnormlag1juntos2, newdata = normalizadoslag1juntos2)
res_normlag1juntos_3 <- predict(rfnormlag1juntos3, newdata = normalizadoslag1juntos3)
res_normlag1juntos_4 <- predict(rfnormlag1juntos4, newdata = normalizadoslag1juntos4)
res_normlag1juntos_5 <- predict(rfnormlag1juntos5, newdata = normalizadoslag1juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1juntos <- ((importance(rfnormlag1juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag1juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag1juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag1juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag1juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1juntos <- ((importance(rfnormlag1juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag1juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag1juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag1juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag1juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1juntos), `Increase Node Purity` = inpnormlag1juntos, IAV = names(inpnormlag1juntos) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1juntos), `% Increase MSE` = imsnormlag1juntos, IAV = names(imsnormlag1juntos) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_norm_lag1_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
d <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1juntos_1, 
              `c) RF 2` = res_normlag1juntos_2, 
              `d) RF 3` = res_normlag1juntos_3, 
              `e) RF 4` = res_normlag1juntos_4, 
              `f) RF 5` = res_normlag1juntos_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d
ggsave('./plots/IAV_res_norm_lag1_juntos.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag1juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1juntos <- res_normlag1juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag1juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag11 <- completoslag1
for (i in names(completoslag11)) {
    completoslag11[is.na(completoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag11)
#             mae <- ModelMetrics::mae(completoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag12 <- completoslag1
for (i in names(completoslag12)) {
    completoslag12[is.na(completoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag12)
#             mae <- c(mae, ModelMetrics::mae(completoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag13 <- completoslag1
for (i in names(completoslag13)) {
    completoslag13[is.na(completoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag13)
#             mae <- c(mae, ModelMetrics::mae(completoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag14 <- completoslag1
for (i in names(completoslag14)) {
    completoslag14[is.na(completoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag14)
#             mae <- c(mae, ModelMetrics::mae(completoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag15 <- completoslag1
for (i in names(completoslag15)) {
    completoslag15[is.na(completoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag15)
#             mae <- c(mae, ModelMetrics::mae(completoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag11 <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 6,  ntree = 300)
rfcomlag11

varImpPlot(rfcomlag11)

set.seed(42)
rfcomlag12 <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 6,  ntree = 300)
rfcomlag12

varImpPlot(rfcomlag12)

set.seed(42)
rfcomlag13 <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 6,  ntree = 300)
rfcomlag13

varImpPlot(rfcomlag13)

set.seed(42)
rfcomlag14 <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 6,  ntree = 300)
rfcomlag14

varImpPlot(rfcomlag14)

set.seed(42)
rfcomlag15 <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 6,  ntree = 300)
rfcomlag15

varImpPlot(rfcomlag15)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag1_1 <- predict(rfcomlag11, newdata = completoslag11)
res_comlag1_2 <- predict(rfcomlag12, newdata = completoslag12)
res_comlag1_3 <- predict(rfcomlag13, newdata = completoslag13)
res_comlag1_4 <- predict(rfcomlag14, newdata = completoslag14)
res_comlag1_5 <- predict(rfcomlag15, newdata = completoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag1 <- ((importance(rfcomlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag1 <- ((importance(rfcomlag11)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag12)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag13)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag14)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag1), `Increase Node Purity` = inpcomlag1, IAV = names(inpcomlag1) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag1), `% Increase MSE` = imscomlag1, IAV = names(imscomlag1) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_comp_lag1.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
e <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag1_1, 
              `c) RF 2` = res_comlag1_2, 
              `d) RF 3` = res_comlag1_3, 
              `e) RF 4` = res_comlag1_4, 
              `f) RF 5` = res_comlag1_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 week lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e
ggsave('./plots/IAV_res_norm_lag1.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag1 <- res_comlag1 %>% 
    rbind(c(Data = 'Training %OM', res_comlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag21 <- normalizadoslag2
for (i in names(normalizadoslag21)) {
    normalizadoslag21[is.na(normalizadoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag21)
#             mae <- ModelMetrics::mae(normalizadoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag22 <- normalizadoslag2
for (i in names(normalizadoslag22)) {
    normalizadoslag22[is.na(normalizadoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag22)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag23 <- normalizadoslag2
for (i in names(normalizadoslag23)) {
    normalizadoslag23[is.na(normalizadoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag23)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag24 <- normalizadoslag2
for (i in names(normalizadoslag24)) {
    normalizadoslag24[is.na(normalizadoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag24)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag25 <- normalizadoslag2
for (i in names(normalizadoslag25)) {
    normalizadoslag25[is.na(normalizadoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag25)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag21 <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 2, mtry = 3,  ntree = 20)
rfnormlag21

varImpPlot(rfnormlag21)

set.seed(42)
rfnormlag22 <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 2, mtry = 3,  ntree = 20)
rfnormlag22

varImpPlot(rfnormlag22)

set.seed(42)
rfnormlag23 <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 2, mtry = 3,  ntree = 20)
rfnormlag23

varImpPlot(rfnormlag23)

set.seed(42)
rfnormlag24 <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 2, mtry = 3,  ntree = 20)
rfnormlag24

varImpPlot(rfnormlag24)

set.seed(42)
rfnormlag25 <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 2, mtry = 3,  ntree = 20)
rfnormlag25

varImpPlot(rfnormlag25)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2_1 <- predict(rfnormlag21, newdata = normalizadoslag21)
res_normlag2_2 <- predict(rfnormlag22, newdata = normalizadoslag22)
res_normlag2_3 <- predict(rfnormlag23, newdata = normalizadoslag23)
res_normlag2_4 <- predict(rfnormlag24, newdata = normalizadoslag24)
res_normlag2_5 <- predict(rfnormlag25, newdata = normalizadoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2 <- ((importance(rfnormlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2 <- ((importance(rfnormlag21)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag22)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag23)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag24)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2), `Increase Node Purity` = inpnormlag2, IAV = names(inpnormlag2) != 'IAV (gc/L) (lag 2)',check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2), `% Increase MSE` = imsnormlag2, IAV = names(imsnormlag2) != 'IAV (gc/L) (lag 2)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_norm_lag2.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
f <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2_1, 
              `c) RF 2` = res_normlag2_2, 
              `d) RF 3` = res_normlag2_3, 
              `e) RF 4` = res_normlag2_4, 
              `f) RF 5` = res_normlag2_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

f
ggsave('./plots/IAV_res_norm_lag2.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2 <- res_normlag2 %>% 
    rbind(c(Data = 'Training %OM', res_normlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos1 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos1)) {
    normalizadoslag2juntos1[is.na(normalizadoslag2juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag2juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos2 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos2)) {
    normalizadoslag2juntos2[is.na(normalizadoslag2juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos3 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos3)) {
    normalizadoslag2juntos3[is.na(normalizadoslag2juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos4 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos4)) {
    normalizadoslag2juntos4[is.na(normalizadoslag2juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos5 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos5)) {
    normalizadoslag2juntos5[is.na(normalizadoslag2juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag2juntos1 <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 5,  ntree = 20)
rfnormlag2juntos1

varImpPlot(rfnormlag2juntos1)

set.seed(42)
rfnormlag2juntos2 <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 5,  ntree = 20)
rfnormlag2juntos2

varImpPlot(rfnormlag2juntos2)

set.seed(42)
rfnormlag2juntos3 <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 5,  ntree = 20)
rfnormlag2juntos3

varImpPlot(rfnormlag2juntos3)

set.seed(42)
rfnormlag2juntos4 <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 5,  ntree = 20)
rfnormlag2juntos4

varImpPlot(rfnormlag2juntos4)

set.seed(42)
rfnormlag2juntos5 <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 5,  ntree = 20)
rfnormlag2juntos5

varImpPlot(rfnormlag2juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2juntos_1 <- predict(rfnormlag2juntos1, newdata = normalizadoslag2juntos1)
res_normlag2juntos_2 <- predict(rfnormlag2juntos2, newdata = normalizadoslag2juntos2)
res_normlag2juntos_3 <- predict(rfnormlag2juntos3, newdata = normalizadoslag2juntos3)
res_normlag2juntos_4 <- predict(rfnormlag2juntos4, newdata = normalizadoslag2juntos4)
res_normlag2juntos_5 <- predict(rfnormlag2juntos5, newdata = normalizadoslag2juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2juntos <- ((importance(rfnormlag2juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag2juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag2juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag2juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag2juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2juntos <- ((importance(rfnormlag2juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag2juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag2juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag2juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag2juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2juntos), `Increase Node Purity` = inpnormlag2juntos, IAV = names(inpnormlag2juntos) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2juntos), `% Increase MSE` = imsnormlag2juntos, IAV = names(imsnormlag2juntos) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_norm_lag2_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
g <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2juntos_1, 
              `c) RF 2` = res_normlag2juntos_2, 
              `d) RF 3` = res_normlag2juntos_3, 
              `e) RF 4` = res_normlag2juntos_4, 
              `f) RF 5` = res_normlag2juntos_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

g
ggsave('./plots/IAV_res_norm_lag2_juntos.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2juntos <- res_normlag2juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag2juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag21 <- completoslag2
for (i in names(completoslag21)) {
    completoslag21[is.na(completoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag21)
#             mae <- ModelMetrics::mae(completoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag22 <- completoslag2
for (i in names(completoslag22)) {
    completoslag22[is.na(completoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag22)
#             mae <- c(mae, ModelMetrics::mae(completoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag23 <- completoslag2
for (i in names(completoslag23)) {
    completoslag23[is.na(completoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag23)
#             mae <- c(mae, ModelMetrics::mae(completoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag24 <- completoslag2
for (i in names(completoslag24)) {
    completoslag24[is.na(completoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag24)
#             mae <- c(mae, ModelMetrics::mae(completoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag25 <- completoslag2
for (i in names(completoslag25)) {
    completoslag25[is.na(completoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag25)
#             mae <- c(mae, ModelMetrics::mae(completoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag21 <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 4,  ntree = 500)
rfcomlag21

varImpPlot(rfcomlag21)

set.seed(42)
rfcomlag22 <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 4,  ntree = 500)
rfcomlag22

varImpPlot(rfcomlag22)

set.seed(42)
rfcomlag23 <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 4,  ntree = 500)
rfcomlag23

varImpPlot(rfcomlag23)

set.seed(42)
rfcomlag24 <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 4,  ntree = 500)
rfcomlag24

varImpPlot(rfcomlag24)

set.seed(42)
rfcomlag25 <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 4,  ntree = 500)
rfcomlag25

varImpPlot(rfcomlag25)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag2_1 <- predict(rfcomlag21, newdata = completoslag21)
res_comlag2_2 <- predict(rfcomlag22, newdata = completoslag22)
res_comlag2_3 <- predict(rfcomlag23, newdata = completoslag23)
res_comlag2_4 <- predict(rfcomlag24, newdata = completoslag24)
res_comlag2_5 <- predict(rfcomlag25, newdata = completoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag2 <- ((importance(rfcomlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag2 <- ((importance(rfcomlag21)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag22)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag23)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag24)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag2), `Increase Node Purity` = inpcomlag2, IAV = names(inpcomlag2) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag2), `% Increase MSE` = imscomlag2, IAV = names(imscomlag2) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_comp_lag2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
h <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag2_1, 
              `c) RF 2` = res_comlag2_2, 
              `d) RF 3` = res_comlag2_3, 
              `e) RF 4` = res_comlag2_4, 
              `f) RF 5` = res_comlag2_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

h
ggsave('./plots/IAV_res_comp_lag2.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag2 <- res_comlag2 %>% 
    rbind(c(Data = 'Training %OM', res_comlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1y2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag121 <- completoslag1y2
for (i in names(completoslag121)) {
    completoslag121[is.na(completoslag121[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag121$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag121)
#             mae <- ModelMetrics::mae(completoslag121$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1y2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag122 <- completoslag1y2
for (i in names(completoslag122)) {
    completoslag122[is.na(completoslag122[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag122$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag122)
#             mae <- c(mae, ModelMetrics::mae(completoslag122$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1y2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag123 <- completoslag1y2
for (i in names(completoslag123)) {
    completoslag123[is.na(completoslag123[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag123$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag123)
#             mae <- c(mae, ModelMetrics::mae(completoslag123$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1y2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag124 <- completoslag1y2
for (i in names(completoslag124)) {
    completoslag124[is.na(completoslag124[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag124$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag124)
#             mae <- c(mae, ModelMetrics::mae(completoslag124$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1y2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag125 <- completoslag1y2
for (i in names(completoslag125)) {
    completoslag125[is.na(completoslag125[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag125$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag125)
#             mae <- c(mae, ModelMetrics::mae(completoslag125$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag121 <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag121$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 5,  ntree = 60)
rfcomlag121

varImpPlot(rfcomlag121)

set.seed(42)
rfcomlag122 <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag122$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 5,  ntree = 60)
rfcomlag122

varImpPlot(rfcomlag122)

set.seed(42)
rfcomlag123 <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag123$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 5,  ntree = 60)
rfcomlag123

varImpPlot(rfcomlag123)

set.seed(42)
rfcomlag124 <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag124$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 5,  ntree = 60)
rfcomlag124

varImpPlot(rfcomlag124)

set.seed(42)
rfcomlag125 <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag125$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 5,  ntree = 60)
rfcomlag125

varImpPlot(rfcomlag125)
```

### Importancia

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
res_comlag12_1 <- predict(rfcomlag121, newdata = completoslag121)
res_comlag12_2 <- predict(rfcomlag122, newdata = completoslag122)
res_comlag12_3 <- predict(rfcomlag123, newdata = completoslag123)
res_comlag12_4 <- predict(rfcomlag124, newdata = completoslag124)
res_comlag12_5 <- predict(rfcomlag125, newdata = completoslag125)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag12 <- ((importance(rfcomlag121)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag122)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag123)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag124)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag125)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag12 <- ((importance(rfcomlag121)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag122)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag123)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag124)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag125)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag12), `Increase Node Purity` = inpcomlag12, IAV = names(inpcomlag12) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag12), `% Increase MSE` = imscomlag12, IAV = names(imscomlag12) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_comp_lag12.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
i <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag12_1, 
              `c) RF 2` = res_comlag12_2, 
              `d) RF 3` = res_comlag12_3, 
              `e) RF 4` = res_comlag12_4, 
              `f) RF 5` = res_comlag12_5, 
              Week = influenza$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 & 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

i
ggsave('./plots/IAV_res_comp_lag12.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag12 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag12_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag12_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag12_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag12_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag12_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag12 <- res_comlag12 %>% 
    rbind(c(Data = 'Training %OM', res_comlag12[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag12[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag12 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Resumen

```{r echo=FALSE, fig.height=27, fig.width=10, message=FALSE, warning=FALSE}
a / b / c / d / e / f / g / h / i
ggsave('./plots/IAV_res_final.pdf', device = 'pdf', height = 27, width = 10, dpi = 320)
```

```{r echo=FALSE}
data.frame(Set = res_comp[, 1], 
           Complete = res_comp[, 7], 
           Normalised = res_norm[, 7], 
           `Normalised 1w lagged` = res_normlag1[, 7], 
           `Normalised and 1w lagged` = res_normlag1juntos[, 7], 
           `Complete and 1w lagged` = res_comlag1[, 7], 
           `Normalised 2w lagged` = res_normlag2[, 7], 
           `Normalised and 2w lagged` = res_normlag2juntos[, 7], 
           `Complete and 2w lagged` = res_comlag2[, 7], 
           `Complete, 1w & 2w lagged` = res_comlag12[, 7], 
           check.names = F) %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
inp <- inpcomlag12 * (1 - mean(res_comlag12[3:4, 7]))
ims <- imscomlag12 * (1 - mean(res_comlag12[3:4, 7]))

for (n in names(inp)) {
    auxi <- 0
    if (n %in% names(inpcomp)) {
        auxi <- auxi + (1 - mean(res_comp[3:4, 7]))
        inp[n] <- inp[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
        ims[n] <- ims[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
    }
    if (n %in% names(inpnorm)) {
        auxi <- auxi + (1 - mean(res_norm[3:4, 7]))
        inp[n] <- inp[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
        ims[n] <- ims[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
    }
    if (n %in% names(inpnormlag1)) {
        auxi <- auxi + (1 - mean(res_normlag1[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag1juntos)) {
        auxi <- auxi + (1 - mean(res_normlag1juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag1)) {
        auxi <- auxi + (1 - mean(res_comlag1[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag2)) {
        auxi <- auxi + (1 - mean(res_normlag2[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
    }
    if (n %in% names(inpnormlag2juntos)) {
        auxi <- auxi + (1 - mean(res_normlag2juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag2)) {
        auxi <- auxi + (1 - mean(res_comlag2[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
    }
    if (n %in% names(inpcomlag12)) {
        auxi <- auxi + (1 - mean(res_comlag12[3:4, 7]))
    }
    inp[n] <- inp[n] / auxi
    ims[n] <- ims[n] / auxi
}

(ggplot(data.frame(Variable = names(inp), `Increase Node Purity` = inp, IAV = names(inp) != 'IAV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = IAV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(ims), `% Increase MSE` = ims, IAV = names(ims) != 'IAV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = IAV), show.legend = F) + 
         ylab(''))
ggsave('./plots/IAV_imp_final.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```

# RSV

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
aux <- rsv %>% 
    cbind(normdata) %>% 
    select(-Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`RSV (gc/L)`})
names(datos) <- paste('RSV (gc/L) *', names(datos))

completos <- cbind(aux, datos[, 3:12])

normalizados <- cbind(aux[, 1:2], datos[, 3:12])

normalizadoslag1 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag1[, 2:12] <- lag(normalizadoslag1[, 2:12] , n = 1)
names(normalizadoslag1)[2:12] <- paste(names(normalizadoslag1)[2:12], '(lag 1)')
normalizadoslag1juntos <- cbind(normalizados, normalizadoslag1[, 2:12])
completoslag1 <- cbind(completos, lag(completos[, 2:22], n = 1))
names(completoslag1)[23:43] <- paste(names(completoslag1)[23:43], '(lag 1)')

normalizadoslag2 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag2[, 2:12] <- lag(normalizadoslag2[, 2:12] , n = 2)
names(normalizadoslag2)[2:12] <- paste(names(normalizadoslag2)[2:12], '(lag 2)')
normalizadoslag2juntos <- cbind(normalizados, normalizadoslag2[, 2:12])
completoslag2 <- cbind(completos, lag(completos[, 2:22], n = 2))
names(completoslag2)[23:43] <- paste(names(completoslag2)[23:43], '(lag 2)')

completoslag1y2 <- cbind(completoslag1, completoslag2[, 23:43])

aux <- rsv %>% 
    cbind(normdata) %>% 
    select(-Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`RSV (gc/L)`})
names(datos) <- paste('RSV (gc/L) *', names(datos))
aux <- cbind(aux, datos[, 3:12])
aux2 <- cbind(aux[, 1:2], datos[, 3:12])
# ------------------------------------------------------------------------------
# Correlations
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_cor.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_pvalues.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_cor_pvalues.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_cor2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_pvalues2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`, n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`, n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`, method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux2 %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`, n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`, n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`, n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`, use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of RSV clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/RSV_cor_pvalues2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

Valores negativos de delay significan Weeks siguientes a la Week correspondiente de los casos clínicos, por ejemplo, delay -1 significa casos clínicos Week 1 correlacionados con los demás datos de la Week 2. Valores positivos lo contrario, correlaciones de los casos clínicos con los datos de las demás variables en las Weeks anteriores, por ejemplo, delay 1 son las correlaciones de los datos clínicos de la Week 2 con los demás datos en la Week 1.

Los delays negativos servirían para ver si hay una correlación (o se produce un efecto, aunque correlación no significa causa) entre las variables medidas en las aguas residuales después de los casos clínicos detectados, como si el virus dejase un rastro a posteriori. Los delays positivos son el caso contrario, ver correlación con Weeks previas, como si intentásemos ver si hay evidencia del virus en las aguas residuales antes de que se contabilicen los casos clínicos.

```{r echo=FALSE, fig.height=18, fig.width=18, message=FALSE, warning=FALSE}
set.seed(666)
test_1 <- sample(1:69, 29)
test_2 <- sample(1:69, 29)
test_3 <- sample(1:69, 29)
test_4 <- sample(1:69, 29)
test_5 <- sample(1:69, 29)
aux <- aux %>% mutate(test1 = 1:69 %in% test_1, 
                      test2 = 1:69 %in% test_2, 
                      test3 = 1:69 %in% test_3, 
                      test4 = 1:69 %in% test_4, 
                      test5 = 1:69 %in% test_5)

ggpairs(completos[, c(1:12)] %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalisation variables')
ggsave('./plots/RSV_ggpairs.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizados %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised level')
ggsave('./plots/RSV_ggpairs2.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizadoslag1 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 1 week lagged level')
ggsave('./plots/RSV_ggpairs3.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizadoslag2 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 2 week lagged level')
ggsave('./plots/RSV_ggpairs4.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)
```

He separado los datos en dos conjuntos (entrenamiento y test) para ajustar los modelos y poder tener una medida en test con las que comparar desempeños. He separado 40 puntos para entrenamiento y 29 para test. Las distribuciones cambian levemente como se puede ver en los histogramas (cambia la mediana y poco más) lo que puede provocar diferencias en los modelos entre los resultados en entrenamiento y test, aunque no serán muy graves ya que las diferencias son leves. Lo ideal es que los dos conjuntos tengan exactamente la misma distribución de los datos, cosa complicada entre menos datos tengamos, por lo que esta separación es más que suficiente.

Además, para eliminar el efecto del que se habla, he repetido lo mismo 5 veces, dividiendo los datos en dos conjuntos (entrnamiento y test) 5 veces, de manera que las métricas de los modelos son la media de los 5 entrenamientos. Esto se denomina cross-validation y sirve para evitar que las métricas de los modelos dependan de la "suerte" o no al separar los datos en entrenamiento y test.

```{r echo=FALSE, fig.height=15, fig.width=10, message=FALSE, warning=FALSE}
a <- aux %>% 
    mutate(Week = rsv$Week, 
           test1 = ifelse(test1, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test1, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 1') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b <- aux %>% 
    mutate(Week = rsv$Week, 
           test2 = ifelse(test2, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test2, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 2') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c <- aux %>% 
    mutate(Week = rsv$Week, 
           test3 = ifelse(test3, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test3, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 3') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d <- aux %>% 
    mutate(Week = rsv$Week, 
           test4 = ifelse(test4, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test4, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 4') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e <- aux %>% 
    mutate(Week = rsv$Week, 
           test5 = ifelse(test5, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test5, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 5') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a / b / c / d / e
ggsave('./plots/RSV_train_test_split.pdf', device = 'pdf', height = 15, width = 10, dpi = 320)
```

## Todas las variables disponibles

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos1 <- completos
for (i in names(completos1)) {
    completos1[is.na(completos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos1)
#             mae <- ModelMetrics::mae(completos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos2 <- completos
for (i in names(completos2)) {
    completos2[is.na(completos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos2)
#             mae <- c(mae, ModelMetrics::mae(completos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos3 <- completos
for (i in names(completos3)) {
    completos3[is.na(completos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos3)
#             mae <- c(mae, ModelMetrics::mae(completos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos4 <- completos
for (i in names(completos4)) {
    completos4[is.na(completos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos4)
#             mae <- c(mae, ModelMetrics::mae(completos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos5 <- completos
for (i in names(completos5)) {
    completos5[is.na(completos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos5)
#             mae <- c(mae, ModelMetrics::mae(completos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

Se han buscado los mejores parámetros para el Random Forest para cada conjunto de entrenamiento con un Grid Search (básicamente probar todas las combinaciones posibles entre un rango dado) modificando nodesize de 1 a 10, mtry de 1 a 10 y ntree de 10 a 100 en incrementos de 10 y 200, 300, 500, 1000.

Significado de los parámetros:

-   nodesize: Tamaño mínimo de los nodos. Los árboles se construyen diviendiendo en grupos por la variable que sea consecutivamente hasta tener una profundidad determinada. Este parámetro fija el número mínimo de observaciones que tienen que tener esos grupos en los que se van separando los datos. Si una división crea grupos más pequeños que este parámetro, la división no se produce y ese nodo se convierte en nodo "terminal", por lo que este parámetro controla la profundidad de los árboles. Por ejemplo, nodesize = 1 indica que los árboles pueden crecer hasta que los nodos contengan una sola observación cada uno.

-   mtry: Es el número de variables que tiene el algoritmo para elegir cada vez que tiene que crear un nodo. Por ejemplo, mtry = 60 indica que cada vez que va a elegir una variable para hacer una división y separar las observaciones, tiene para elegir entre un conjunto aleatorio de 60 variables del total que haya (en este caso 181).

-   ntree: Es el número de árboles diferentes que va a generar. La predicción final es la clase más votada entre todos estos árboles (en este caso las clases son las diferentes muestras).

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfcom1 <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), y = completos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 9,  ntree = 20)
rfcom1

varImpPlot(rfcom1)

set.seed(42)
rfcom2 <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), y = completos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 9,  ntree = 20)
rfcom2

varImpPlot(rfcom2)

set.seed(42)
rfcom3 <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), y = completos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 9,  ntree = 20)
rfcom3

varImpPlot(rfcom3)

set.seed(42)
rfcom4 <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), y = completos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 9,  ntree = 20)
rfcom4

varImpPlot(rfcom4)

set.seed(42)
rfcom5 <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), y = completos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 9,  ntree = 20)
rfcom5

varImpPlot(rfcom5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_comp_1 <- predict(rfcom1, newdata = completos1)
res_comp_2 <- predict(rfcom2, newdata = completos2)
res_comp_3 <- predict(rfcom3, newdata = completos3)
res_comp_4 <- predict(rfcom4, newdata = completos4)
res_comp_5 <- predict(rfcom5, newdata = completos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomp <- ((importance(rfcom1)[, 'IncNodePurity'] * e1) + 
                (importance(rfcom2)[, 'IncNodePurity'] * e2) + 
                (importance(rfcom3)[, 'IncNodePurity'] * e3) + 
                (importance(rfcom4)[, 'IncNodePurity'] * e4) + 
                (importance(rfcom5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomp <- ((importance(rfcom1)[, '%IncMSE'] * e1) + 
                (importance(rfcom2)[, '%IncMSE'] * e2) + 
                (importance(rfcom3)[, '%IncMSE'] * e3) + 
                (importance(rfcom4)[, '%IncMSE'] * e4) + 
                (importance(rfcom5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomp), `Increase Node Purity` = inpcomp, RSV = names(inpcomp) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomp), `% Increase MSE` = imscomp, RSV = names(imscomp) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_comp.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
a <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comp_1, 
              `c) RF 2` = res_comp_2, 
              `d) RF 3` = res_comp_3, 
              `e) RF 4` = res_comp_4, 
              `f) RF 5` = res_comp_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a
ggsave('./plots/RSV_res_comp.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comp <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comp_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comp_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comp_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comp_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comp_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comp <- res_comp %>% 
    rbind(c(Data = 'Training %OM', res_comp[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comp[2, -1] / mean(aux$`Clinical cases`))) 

res_comp %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizados %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados1 <- normalizados
for (i in names(normalizados1)) {
    normalizados1[is.na(normalizados1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados1)
#             mae <- ModelMetrics::mae(normalizados1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizados %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados2 <- normalizados
for (i in names(normalizados2)) {
    normalizados2[is.na(normalizados2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados2)
#             mae <- c(mae, ModelMetrics::mae(normalizados2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizados %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados3 <- normalizados
for (i in names(normalizados3)) {
    normalizados3[is.na(normalizados3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados3)
#             mae <- c(mae, ModelMetrics::mae(normalizados3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizados %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados4 <- normalizados
for (i in names(normalizados4)) {
    normalizados4[is.na(normalizados4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados4)
#             mae <- c(mae, ModelMetrics::mae(normalizados4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizados %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados5 <- normalizados
for (i in names(normalizados5)) {
    normalizados5[is.na(normalizados5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados5)
#             mae <- c(mae, ModelMetrics::mae(normalizados5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnorm1 <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
                        y = normalizados1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 6,  ntree = 10)
rfnorm1

varImpPlot(rfnorm1)

set.seed(42)
rfnorm2 <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
                        y = normalizados2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 6,  ntree = 10)
rfnorm2

varImpPlot(rfnorm2)

set.seed(42)
rfnorm3 <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
                        y = normalizados3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 6,  ntree = 10)
rfnorm3

varImpPlot(rfnorm3)

set.seed(42)
rfnorm4 <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
                        y = normalizados4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 6,  ntree = 10)
rfnorm4

varImpPlot(rfnorm4)

set.seed(42)
rfnorm5 <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
                        y = normalizados5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 6,  ntree = 10)
rfnorm5

varImpPlot(rfnorm5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_norm_1 <- predict(rfnorm1, newdata = normalizados1)
res_norm_2 <- predict(rfnorm2, newdata = normalizados2)
res_norm_3 <- predict(rfnorm3, newdata = normalizados3)
res_norm_4 <- predict(rfnorm4, newdata = normalizados4)
res_norm_5 <- predict(rfnorm5, newdata = normalizados5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnorm <- ((importance(rfnorm1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnorm2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnorm3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnorm4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnorm5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnorm <- ((importance(rfnorm1)[, '%IncMSE'] * e1) + 
                (importance(rfnorm2)[, '%IncMSE'] * e2) + 
                (importance(rfnorm3)[, '%IncMSE'] * e3) + 
                (importance(rfnorm4)[, '%IncMSE'] * e4) + 
                (importance(rfnorm5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnorm), `Increase Node Purity` = inpnorm, RSV = names(inpnorm) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnorm), `% Increase MSE` = imsnorm, RSV = names(imsnorm) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_norm.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
b <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_norm_1, 
              `c) RF 2` = res_norm_2, 
              `d) RF 3` = res_norm_3, 
              `e) RF 4` = res_norm_4, 
              `f) RF 5` = res_norm_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b
ggsave('./plots/RSV_res_norm.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_norm <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_norm_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_norm_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_norm_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_norm_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_norm_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_norm <- res_norm %>% 
    rbind(c(Data = 'Training %OM', res_norm[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_norm[2, -1] / mean(aux$`Clinical cases`))) 

res_norm %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag11 <- normalizadoslag1
for (i in names(normalizadoslag11)) {
    normalizadoslag11[is.na(normalizadoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag11)
#             mae <- ModelMetrics::mae(normalizadoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag12 <- normalizadoslag1
for (i in names(normalizadoslag12)) {
    normalizadoslag12[is.na(normalizadoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag12)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag13 <- normalizadoslag1
for (i in names(normalizadoslag13)) {
    normalizadoslag13[is.na(normalizadoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag13)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag14 <- normalizadoslag1
for (i in names(normalizadoslag14)) {
    normalizadoslag14[is.na(normalizadoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag14)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag15 <- normalizadoslag1
for (i in names(normalizadoslag15)) {
    normalizadoslag15[is.na(normalizadoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag15)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag11 <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 3,  ntree = 100)
rfnormlag11

varImpPlot(rfnormlag11)

set.seed(42)
rfnormlag12 <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 3,  ntree = 100)
rfnormlag12

varImpPlot(rfnormlag12)

set.seed(42)
rfnormlag13 <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 3,  ntree = 100)
rfnormlag13

varImpPlot(rfnormlag13)

set.seed(42)
rfnormlag14 <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 3,  ntree = 100)
rfnormlag14

varImpPlot(rfnormlag14)

set.seed(42)
rfnormlag15 <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 3,  ntree = 100)
rfnormlag15

varImpPlot(rfnormlag15)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1_1 <- predict(rfnormlag11, newdata = normalizadoslag11)
res_normlag1_2 <- predict(rfnormlag12, newdata = normalizadoslag12)
res_normlag1_3 <- predict(rfnormlag13, newdata = normalizadoslag13)
res_normlag1_4 <- predict(rfnormlag14, newdata = normalizadoslag14)
res_normlag1_5 <- predict(rfnormlag15, newdata = normalizadoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1 <- ((importance(rfnormlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1 <- ((importance(rfnormlag11)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag12)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag13)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag14)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1), `Increase Node Purity` = inpnormlag1, RSV = names(inpnormlag1) != 'RSV (gc/L) (lag 1)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1), `% Increase MSE` = imsnormlag1,RSV = names(imsnormlag1) != 'RSV (gc/L) (lag 1)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_norm_lag1.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
c <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1_1, 
              `c) RF 2` = res_normlag1_2, 
              `d) RF 3` = res_normlag1_3, 
              `e) RF 4` = res_normlag1_4, 
              `f) RF 5` = res_normlag1_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c
ggsave('./plots/RSV_res_norm_lag1.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1 <- res_normlag1 %>% 
    rbind(c(Data = 'Training %OM', res_normlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos1 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos1)) {
    normalizadoslag1juntos1[is.na(normalizadoslag1juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag1juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos2 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos2)) {
    normalizadoslag1juntos2[is.na(normalizadoslag1juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos3 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos3)) {
    normalizadoslag1juntos3[is.na(normalizadoslag1juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos4 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos4)) {
    normalizadoslag1juntos4[is.na(normalizadoslag1juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos5 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos5)) {
    normalizadoslag1juntos5[is.na(normalizadoslag1juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag1juntos1 <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 3, mtry = 12,  ntree = 20)
rfnormlag1juntos1

varImpPlot(rfnormlag1juntos1)

set.seed(42)
rfnormlag1juntos2 <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 3, mtry = 12,  ntree = 20)
rfnormlag1juntos2

varImpPlot(rfnormlag1juntos2)

set.seed(42)
rfnormlag1juntos3 <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 3, mtry = 12,  ntree = 20)
rfnormlag1juntos3

varImpPlot(rfnormlag1juntos3)

set.seed(42)
rfnormlag1juntos4 <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 3, mtry = 12,  ntree = 20)
rfnormlag1juntos4

varImpPlot(rfnormlag1juntos4)

set.seed(42)
rfnormlag1juntos5 <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 3, mtry = 12,  ntree = 20)
rfnormlag1juntos5

varImpPlot(rfnormlag1juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1juntos_1 <- predict(rfnormlag1juntos1, newdata = normalizadoslag1juntos1)
res_normlag1juntos_2 <- predict(rfnormlag1juntos2, newdata = normalizadoslag1juntos2)
res_normlag1juntos_3 <- predict(rfnormlag1juntos3, newdata = normalizadoslag1juntos3)
res_normlag1juntos_4 <- predict(rfnormlag1juntos4, newdata = normalizadoslag1juntos4)
res_normlag1juntos_5 <- predict(rfnormlag1juntos5, newdata = normalizadoslag1juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1juntos <- ((importance(rfnormlag1juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag1juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag1juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag1juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag1juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1juntos <- ((importance(rfnormlag1juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag1juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag1juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag1juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag1juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1juntos), `Increase Node Purity` = inpnormlag1juntos, RSV = names(inpnormlag1juntos) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1juntos), `% Increase MSE` = imsnormlag1juntos, RSV = names(imsnormlag1juntos) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_norm_lag1_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
d <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1juntos_1, 
              `c) RF 2` = res_normlag1juntos_2, 
              `d) RF 3` = res_normlag1juntos_3, 
              `e) RF 4` = res_normlag1juntos_4, 
              `f) RF 5` = res_normlag1juntos_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d
ggsave('./plots/RSV_res_norm_lag1_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

```{r echo=FALSE}
res_normlag1juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1juntos <- res_normlag1juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag1juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag11 <- completoslag1
for (i in names(completoslag11)) {
    completoslag11[is.na(completoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag11)
#             mae <- ModelMetrics::mae(completoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag12 <- completoslag1
for (i in names(completoslag12)) {
    completoslag12[is.na(completoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag12)
#             mae <- c(mae, ModelMetrics::mae(completoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag13 <- completoslag1
for (i in names(completoslag13)) {
    completoslag13[is.na(completoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag13)
#             mae <- c(mae, ModelMetrics::mae(completoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag14 <- completoslag1
for (i in names(completoslag14)) {
    completoslag14[is.na(completoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag14)
#             mae <- c(mae, ModelMetrics::mae(completoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag15 <- completoslag1
for (i in names(completoslag15)) {
    completoslag15[is.na(completoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag15)
#             mae <- c(mae, ModelMetrics::mae(completoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag11 <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 21,  ntree = 50)
rfcomlag11

varImpPlot(rfcomlag11)

set.seed(42)
rfcomlag12 <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 21,  ntree = 50)
rfcomlag12

varImpPlot(rfcomlag12)

set.seed(42)
rfcomlag13 <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 21,  ntree = 50)
rfcomlag13

varImpPlot(rfcomlag13)

set.seed(42)
rfcomlag14 <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 21,  ntree = 50)
rfcomlag14

varImpPlot(rfcomlag14)

set.seed(42)
rfcomlag15 <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 21,  ntree = 50)
rfcomlag15

varImpPlot(rfcomlag15)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag1_1 <- predict(rfcomlag11, newdata = completoslag11)
res_comlag1_2 <- predict(rfcomlag12, newdata = completoslag12)
res_comlag1_3 <- predict(rfcomlag13, newdata = completoslag13)
res_comlag1_4 <- predict(rfcomlag14, newdata = completoslag14)
res_comlag1_5 <- predict(rfcomlag15, newdata = completoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag1 <- ((importance(rfcomlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag1 <- ((importance(rfcomlag11)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag12)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag13)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag14)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag1), `Increase Node Purity` = inpcomlag1, RSV = names(inpcomlag1) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag1), `% Increase MSE` = imscomlag1, RSV = names(imscomlag1) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_comp_lag1.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
e <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag1_1, 
              `c) RF 2` = res_comlag1_2, 
              `d) RF 3` = res_comlag1_3, 
              `e) RF 4` = res_comlag1_4, 
              `f) RF 5` = res_comlag1_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 week lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e
ggsave('./plots/RSV_res_comp_lag1.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag1 <- res_comlag1 %>% 
    rbind(c(Data = 'Training %OM', res_comlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag21 <- normalizadoslag2
for (i in names(normalizadoslag21)) {
    normalizadoslag21[is.na(normalizadoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag21)
#             mae <- ModelMetrics::mae(normalizadoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag22 <- normalizadoslag2
for (i in names(normalizadoslag22)) {
    normalizadoslag22[is.na(normalizadoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag22)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag23 <- normalizadoslag2
for (i in names(normalizadoslag23)) {
    normalizadoslag23[is.na(normalizadoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag23)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag24 <- normalizadoslag2
for (i in names(normalizadoslag24)) {
    normalizadoslag24[is.na(normalizadoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag24)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag25 <- normalizadoslag2
for (i in names(normalizadoslag25)) {
    normalizadoslag25[is.na(normalizadoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag25)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag21 <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 11,  ntree = 10)
rfnormlag21

varImpPlot(rfnormlag21)

set.seed(42)
rfnormlag22 <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 11,  ntree = 10)
rfnormlag22

varImpPlot(rfnormlag22)

set.seed(42)
rfnormlag23 <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 11,  ntree = 10)
rfnormlag23

varImpPlot(rfnormlag23)

set.seed(42)
rfnormlag24 <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 11,  ntree = 10)
rfnormlag24

varImpPlot(rfnormlag24)

set.seed(42)
rfnormlag25 <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 11,  ntree = 10)
rfnormlag25

varImpPlot(rfnormlag25)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2_1 <- predict(rfnormlag21, newdata = normalizadoslag21)
res_normlag2_2 <- predict(rfnormlag22, newdata = normalizadoslag22)
res_normlag2_3 <- predict(rfnormlag23, newdata = normalizadoslag23)
res_normlag2_4 <- predict(rfnormlag24, newdata = normalizadoslag24)
res_normlag2_5 <- predict(rfnormlag25, newdata = normalizadoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2 <- ((importance(rfnormlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2 <- ((importance(rfnormlag21)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag22)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag23)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag24)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2), `Increase Node Purity` = inpnormlag2, RSV = names(inpnormlag2) != 'RSV (gc/L) (lag 2)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2), `% Increase MSE` = imsnormlag2, RSV = names(imsnormlag2) != 'RSV (gc/L) (lag 2)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_norm_lag2.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
f <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2_1, 
              `c) RF 2` = res_normlag2_2, 
              `d) RF 3` = res_normlag2_3, 
              `e) RF 4` = res_normlag2_4, 
              `f) RF 5` = res_normlag2_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

f
ggsave('./plots/RSV_res_norm_lag2.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2 <- res_normlag2 %>% 
    rbind(c(Data = 'Training %OM', res_normlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos1 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos1)) {
    normalizadoslag2juntos1[is.na(normalizadoslag2juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag2juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos2 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos2)) {
    normalizadoslag2juntos2[is.na(normalizadoslag2juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos3 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos3)) {
    normalizadoslag2juntos3[is.na(normalizadoslag2juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos4 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos4)) {
    normalizadoslag2juntos4[is.na(normalizadoslag2juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos5 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos5)) {
    normalizadoslag2juntos5[is.na(normalizadoslag2juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag2juntos1 <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 2, mtry = 2,  ntree = 100)
rfnormlag2juntos1

varImpPlot(rfnormlag2juntos1)

set.seed(42)
rfnormlag2juntos2 <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 2, mtry = 2,  ntree = 100)
rfnormlag2juntos2

varImpPlot(rfnormlag2juntos2)

set.seed(42)
rfnormlag2juntos3 <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 2, mtry = 2,  ntree = 100)
rfnormlag2juntos3

varImpPlot(rfnormlag2juntos3)

set.seed(42)
rfnormlag2juntos4 <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 2, mtry = 2,  ntree = 100)
rfnormlag2juntos4

varImpPlot(rfnormlag2juntos4)

set.seed(42)
rfnormlag2juntos5 <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 2, mtry = 2,  ntree = 100)
rfnormlag2juntos5

varImpPlot(rfnormlag2juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2juntos_1 <- predict(rfnormlag2juntos1, newdata = normalizadoslag2juntos1)
res_normlag2juntos_2 <- predict(rfnormlag2juntos2, newdata = normalizadoslag2juntos2)
res_normlag2juntos_3 <- predict(rfnormlag2juntos3, newdata = normalizadoslag2juntos3)
res_normlag2juntos_4 <- predict(rfnormlag2juntos4, newdata = normalizadoslag2juntos4)
res_normlag2juntos_5 <- predict(rfnormlag2juntos5, newdata = normalizadoslag2juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2juntos <- ((importance(rfnormlag2juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag2juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag2juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag2juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag2juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2juntos <- ((importance(rfnormlag2juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag2juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag2juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag2juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag2juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2juntos), `Increase Node Purity` = inpnormlag2juntos, RSV = names(inpnormlag2juntos) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2juntos), `% Increase MSE` = imsnormlag2juntos, RSV = names(imsnormlag2juntos) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_norm_lag2_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
g <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2juntos_1, 
              `c) RF 2` = res_normlag2juntos_2, 
              `d) RF 3` = res_normlag2juntos_3, 
              `e) RF 4` = res_normlag2juntos_4, 
              `f) RF 5` = res_normlag2juntos_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

g
ggsave('./plots/RSV_res_norm_lag2_juntos.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2juntos <- res_normlag2juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag2juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag21 <- completoslag2
for (i in names(completoslag21)) {
    completoslag21[is.na(completoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag21)
#             mae <- ModelMetrics::mae(completoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag22 <- completoslag2
for (i in names(completoslag22)) {
    completoslag22[is.na(completoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag22)
#             mae <- c(mae, ModelMetrics::mae(completoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag23 <- completoslag2
for (i in names(completoslag23)) {
    completoslag23[is.na(completoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag23)
#             mae <- c(mae, ModelMetrics::mae(completoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag24 <- completoslag2
for (i in names(completoslag24)) {
    completoslag24[is.na(completoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag24)
#             mae <- c(mae, ModelMetrics::mae(completoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag25 <- completoslag2
for (i in names(completoslag25)) {
    completoslag25[is.na(completoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag25)
#             mae <- c(mae, ModelMetrics::mae(completoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag21 <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 7,  ntree = 90)
rfcomlag21

varImpPlot(rfcomlag21)

set.seed(42)
rfcomlag22 <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 7,  ntree = 90)
rfcomlag22

varImpPlot(rfcomlag22)

set.seed(42)
rfcomlag23 <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 7,  ntree = 90)
rfcomlag23

varImpPlot(rfcomlag23)

set.seed(42)
rfcomlag24 <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 7,  ntree = 90)
rfcomlag24

varImpPlot(rfcomlag24)

set.seed(42)
rfcomlag25 <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 7,  ntree = 90)
rfcomlag25

varImpPlot(rfcomlag25)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag2_1 <- predict(rfcomlag21, newdata = completoslag21)
res_comlag2_2 <- predict(rfcomlag22, newdata = completoslag22)
res_comlag2_3 <- predict(rfcomlag23, newdata = completoslag23)
res_comlag2_4 <- predict(rfcomlag24, newdata = completoslag24)
res_comlag2_5 <- predict(rfcomlag25, newdata = completoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag2 <- ((importance(rfcomlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag2 <- ((importance(rfcomlag21)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag22)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag23)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag24)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag2), `Increase Node Purity` = inpcomlag2, RSV = names(inpcomlag2) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag2), `% Increase MSE` = imscomlag2, RSV = names(imscomlag2) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_comp_lag2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
h <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag2_1, 
              `c) RF 2` = res_comlag2_2, 
              `d) RF 3` = res_comlag2_3, 
              `e) RF 4` = res_comlag2_4, 
              `f) RF 5` = res_comlag2_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

h
ggsave('./plots/RSV_res_comp_lag2.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag2 <- res_comlag2 %>% 
    rbind(c(Data = 'Training %OM', res_comlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1y2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag121 <- completoslag1y2
for (i in names(completoslag121)) {
    completoslag121[is.na(completoslag121[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag121$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag121)
#             mae <- ModelMetrics::mae(completoslag121$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1y2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag122 <- completoslag1y2
for (i in names(completoslag122)) {
    completoslag122[is.na(completoslag122[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag122$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag122)
#             mae <- c(mae, ModelMetrics::mae(completoslag122$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1y2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag123 <- completoslag1y2
for (i in names(completoslag123)) {
    completoslag123[is.na(completoslag123[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag123$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag123)
#             mae <- c(mae, ModelMetrics::mae(completoslag123$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1y2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag124 <- completoslag1y2
for (i in names(completoslag124)) {
    completoslag124[is.na(completoslag124[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag124$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag124)
#             mae <- c(mae, ModelMetrics::mae(completoslag124$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1y2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag125 <- completoslag1y2
for (i in names(completoslag125)) {
    completoslag125[is.na(completoslag125[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag125$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag125)
#             mae <- c(mae, ModelMetrics::mae(completoslag125$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag121 <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag121$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 8,  ntree = 30)
rfcomlag121

varImpPlot(rfcomlag121)

set.seed(42)
rfcomlag122 <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag122$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 8,  ntree = 30)
rfcomlag122

varImpPlot(rfcomlag122)

set.seed(42)
rfcomlag123 <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag123$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 8,  ntree = 30)
rfcomlag123

varImpPlot(rfcomlag123)

set.seed(42)
rfcomlag124 <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag124$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 8,  ntree = 30)
rfcomlag124

varImpPlot(rfcomlag124)

set.seed(42)
rfcomlag125 <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag125$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 8,  ntree = 30)
rfcomlag125

varImpPlot(rfcomlag125)
```

### Importancia

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
res_comlag12_1 <- predict(rfcomlag121, newdata = completoslag121)
res_comlag12_2 <- predict(rfcomlag122, newdata = completoslag122)
res_comlag12_3 <- predict(rfcomlag123, newdata = completoslag123)
res_comlag12_4 <- predict(rfcomlag124, newdata = completoslag124)
res_comlag12_5 <- predict(rfcomlag125, newdata = completoslag125)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag12 <- ((importance(rfcomlag121)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag122)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag123)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag124)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag125)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag12 <- ((importance(rfcomlag121)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag122)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag123)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag124)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag125)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag12), `Increase Node Purity` = inpcomlag12, RSV = names(inpcomlag12) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag12), `% Increase MSE` = imscomlag12, RSV = names(imscomlag12) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_comp_lag12.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
i <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag12_1, 
              `c) RF 2` = res_comlag12_2, 
              `d) RF 3` = res_comlag12_3, 
              `e) RF 4` = res_comlag12_4, 
              `f) RF 5` = res_comlag12_5, 
              Week = rsv$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 & 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

i
ggsave('./plots/RSV_res_comp_lag12.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag12 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag12_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag12_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag12_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag12_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag12_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag12 <- res_comlag12 %>% 
    rbind(c(Data = 'Training %OM', res_comlag12[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag12[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag12 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Resumen

```{r echo=FALSE, fig.height=27, fig.width=10, message=FALSE, warning=FALSE}
a / b / c / d / e / f / g / h / i
ggsave('./plots/RSV_res_final.pdf', device = 'pdf', height = 27, width = 10, dpi = 320)
```

```{r echo=FALSE}
data.frame(Set = res_comp[, 1], 
           Complete = res_comp[, 7], 
           Normalised = res_norm[, 7], 
           `Normalised 1w lagged` = res_normlag1[, 7], 
           `Normalised and 1w lagged` = res_normlag1juntos[, 7], 
           `Complete and 1w lagged` = res_comlag1[, 7], 
           `Normalised 2w lagged` = res_normlag2[, 7], 
           `Normalised and 2w lagged` = res_normlag2juntos[, 7], 
           `Complete and 2w lagged` = res_comlag2[, 7], 
           `Complete, 1w & 2w lagged` = res_comlag12[, 7], 
           check.names = F) %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
inp <- inpcomlag12 * (1 - mean(res_comlag12[3:4, 7]))
ims <- imscomlag12 * (1 - mean(res_comlag12[3:4, 7]))

for (n in names(inp)) {
    auxi <- 0
    if (n %in% names(inpcomp)) {
        auxi <- auxi + (1 - mean(res_comp[3:4, 7]))
        inp[n] <- inp[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
        ims[n] <- ims[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
    }
    if (n %in% names(inpnorm)) {
        auxi <- auxi + (1 - mean(res_norm[3:4, 7]))
        inp[n] <- inp[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
        ims[n] <- ims[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
    }
    if (n %in% names(inpnormlag1)) {
        auxi <- auxi + (1 - mean(res_normlag1[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag1juntos)) {
        auxi <- auxi + (1 - mean(res_normlag1juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag1)) {
        auxi <- auxi + (1 - mean(res_comlag1[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag2)) {
        auxi <- auxi + (1 - mean(res_normlag2[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
    }
    if (n %in% names(inpnormlag2juntos)) {
        auxi <- auxi + (1 - mean(res_normlag2juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag2)) {
        auxi <- auxi + (1 - mean(res_comlag2[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
    }
    if (n %in% names(inpcomlag12)) {
        auxi <- auxi + (1 - mean(res_comlag12[3:4, 7]))
    }
    inp[n] <- inp[n] / auxi
    ims[n] <- ims[n] / auxi
}

(ggplot(data.frame(Variable = names(inp), `Increase Node Purity` = inp, RSV = names(inp) != 'RSV (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = RSV), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(ims), `% Increase MSE` = ims, RSV = names(ims) != 'RSV (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = RSV), show.legend = F) + 
         ylab(''))
ggsave('./plots/RSV_imp_final.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```

# SARS-CoV-2

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
aux <- covid %>% 
    cbind(normdata) %>% 
    select(-Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`SARS-CoV-2 (gc/L)`})
names(datos) <- paste('SARS-CoV-2 (gc/L) *', names(datos))

completos <- cbind(aux, datos[, 3:12])

normalizados <- cbind(aux[, 1:2], datos[, 3:12])

normalizadoslag1 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag1[, 2:12] <- lag(normalizadoslag1[, 2:12] , n = 1)
names(normalizadoslag1)[2:12] <- paste(names(normalizadoslag1)[2:12], '(lag 1)')
normalizadoslag1juntos <- cbind(normalizados, normalizadoslag1[, 2:12])
completoslag1 <- cbind(completos, lag(completos[, 2:22], n = 1))
names(completoslag1)[23:43] <- paste(names(completoslag1)[23:43], '(lag 1)')

normalizadoslag2 <- cbind(aux[, 1:2], datos[, 3:12])
normalizadoslag2[, 2:12] <- lag(normalizadoslag2[, 2:12] , n = 2)
names(normalizadoslag2)[2:12] <- paste(names(normalizadoslag2)[2:12], '(lag 2)')
normalizadoslag2juntos <- cbind(normalizados, normalizadoslag2[, 2:12])
completoslag2 <- cbind(completos, lag(completos[, 2:22], n = 2))
names(completoslag2)[23:43] <- paste(names(completoslag2)[23:43], '(lag 2)')

completoslag1y2 <- cbind(completoslag1, completoslag2[, 23:43])

aux <- covid %>% 
    cbind(normdata) %>% 
    select(-Week) %>% 
    as.data.frame() 
datos <- aux %>% 
    mutate_at(3:12, function(x) {x * aux$`SARS-CoV-2 (gc/L)`})
names(datos) <- paste('SARS-CoV-2 (gc/L) *', names(datos))
aux <- cbind(aux, datos[, 3:12])
aux2 <- cbind(aux[, 1:2], datos[, 3:12])
# ------------------------------------------------------------------------------
a <- completos[1:24, ] %>%
    summarise_at(names(completos)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`[1:24], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases before April 2022', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor_ba.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)

a <- completos[25:69, ] %>%
    summarise_at(names(completos)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`[25:69], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`[25:69], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[25:69], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[25:69], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[25:69], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`[25:69], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases after March 2022', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor_am.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations
a <- aux[1:24, ] %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`[1:24], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux[1:24, ] %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`[1:24], n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_pvalues.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux[1:24, ] %>%
    summarise_at(names(aux)[-1], function(x) {c(cor.test(x, lag(aux$`Clinical cases`[1:24], n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux$`Clinical cases`[1:24], n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux[1:24, ] %>%
    summarise_at(names(aux)[-1], function(x) {c(cor(x, lag(aux$`Clinical cases`[1:24], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux$`Clinical cases`[1:24], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor_pvalues.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations
a <- aux2[1:24, ] %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`[1:24], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(high = '#9e2a2a', low = '#2022cf', limits = c(-1, 1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# p-values
a <- aux2[1:24, ] %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = value), color = 'white') + 
    geom_text(aes(label = round(value, 6))) + 
    ylab('') + 
    ggtitle('Correlations\' p-values of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_pvalues2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
# ------------------------------------------------------------------------------
# Correlations color p-values
pvalues <- aux2[1:24, ] %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 5), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 4), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 3), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 2), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, lag(aux2$`Clinical cases`[1:24], n = 1), method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(x, aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 1), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 2), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value, 
                                                cor.test(lag(x, n = 3), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 4), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value,
                                                cor.test(lag(x, n = 5), aux2$`Clinical cases`[1:24], method = "spearman", exact = T, continuity = T, alternative = "two.sided")$p.value)}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay)
a <- aux2[1:24, ] %>%
    summarise_at(names(aux2)[-1], function(x) {c(cor(x, lag(aux2$`Clinical cases`[1:24], n = 5), use = "pairwise.complete.obs", method = "spearman"),
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 4), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 3), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 2), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, lag(aux2$`Clinical cases`[1:24], n = 1), use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(x, aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 1), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 2), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"), 
                                                cor(lag(x, n = 3), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 4), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"),
                                                cor(lag(x, n = 5), aux2$`Clinical cases`[1:24], use = "pairwise.complete.obs", method = "spearman"))}) %>% 
    mutate(Delay = factor(-5:5, levels = -5:5, ordered = T)) %>% 
    pivot_longer(-Delay) %>% 
    mutate(`p-values` = pvalues$value) %>% 
    ggplot(aes(y = factor(name, levels = unique(name), ordered = T), x = Delay)) + 
    geom_tile(aes(fill = `p-values`), color = 'white') + 
    geom_text(aes(label = round(value, 3))) + 
    ylab('') + 
    ggtitle('Correlation of SARS-CoV-2 clinical cases', subtitle = 'Lag from -5 to 5 weeks') + 
    scale_fill_gradient2(low = '#9e2a2a', high = '#2022cf', midpoint = 0.05, limits = c(0, 0.1)) + 
    theme(title = element_text(size = 8))

a
ggsave('./plots/SARS_cor_pvalues2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

Valores negativos de delay significan Weeks siguientes a la Week correspondiente de los casos clínicos, por ejemplo, delay -1 significa casos clínicos Week 1 correlacionados con los demás datos de la Week 2. Valores positivos lo contrario, correlaciones de los casos clínicos con los datos de las demás variables en las Weeks anteriores, por ejemplo, delay 1 son las correlaciones de los datos clínicos de la Week 2 con los demás datos en la Week 1.

Los delays negativos servirían para ver si hay una correlación (o se produce un efecto, aunque correlación no significa causa) entre las variables medidas en las aguas residuales después de los casos clínicos detectados, como si el virus dejase un rastro a posteriori. Los delays positivos son el caso contrario, ver correlación con Weeks previas, como si intentásemos ver si hay evidencia del virus en las aguas residuales antes de que se contabilicen los casos clínicos.

```{r echo=FALSE, fig.height=18, fig.width=18, message=FALSE, warning=FALSE}
aux <- aux %>% mutate(Week = influenza$Week)
aux <- aux[1:24, ]
completos <- completos[1:24, ]
normalizados <- normalizados[1:24, ]
normalizadoslag1 <- normalizadoslag1[1:24, ]
normalizadoslag1juntos <- normalizadoslag1juntos[1:24, ]
completoslag1 <- completoslag1[1:24, ]
normalizadoslag2 <- normalizadoslag2[1:24, ]
normalizadoslag2juntos <- normalizadoslag2juntos[1:24, ]
completoslag2 <- completoslag2[1:24, ]
completoslag1y2 <- completoslag1y2[1:24, ]

set.seed(666)
test_1 <- sample(1:24, 12)
test_2 <- sample(1:24, 12)
test_3 <- sample(1:24, 12)
test_4 <- sample(1:24, 12)
test_5 <- sample(1:24, 12)
aux <- aux %>% mutate(test1 = 1:24 %in% test_1, 
                      test2 = 1:24 %in% test_2, 
                      test3 = 1:24 %in% test_3, 
                      test4 = 1:24 %in% test_4, 
                      test5 = 1:24 %in% test_5)

ggpairs(completos[, c(1:12)] %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalisation variables')
ggsave('./plots/SARS_ggpairs.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizados %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised level')
ggsave('./plots/SARS_ggpairs2.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizadoslag1 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 1 week lagged level')
ggsave('./plots/SARS_ggpairs3.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)

ggpairs(normalizadoslag2 %>% mutate(test1 = ifelse(aux$test1, 'Test', 'Training')), 
        mapping = aes(colour = test1, alpha = 0.7), 
        upper = list(continuous = wrap("cor", use = "pairwise.complete.obs", method = "spearman")), 
        title = 'Normalised 2 week lagged level')
ggsave('./plots/SARS_ggpairs4.pdf', device = 'pdf', height = 18, width = 18, dpi = 320)
```

He separado los datos en dos conjuntos (entrenamiento y test) para ajustar los modelos y poder tener una medida en test con las que comparar desempeños. He separado 12 puntos para entrenamiento y 12 para test. Las distribuciones cambian levemente como se puede ver en los histogramas (cambia la mediana y poco más) lo que puede provocar diferencias en los modelos entre los resultados en entrenamiento y test, aunque no serán muy graves ya que las diferencias son leves. Lo ideal es que los dos conjuntos tengan exactamente la misma distribución de los datos, cosa complicada entre menos datos tengamos, por lo que esta separación es más que suficiente.

Además, para eliminar el efecto del que se habla, he repetido lo mismo 5 veces, dividiendo los datos en dos conjuntos (entrnamiento y test) 5 veces, de manera que las métricas de los modelos son la media de los 5 entrenamientos. Esto se denomina cross-validation y sirve para evitar que las métricas de los modelos dependan de la "suerte" o no al separar los datos en entrenamiento y test.

```{r echo=FALSE, fig.height=15, fig.width=10, message=FALSE, warning=FALSE}
a <- aux %>% 
    mutate(test1 = ifelse(test1, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test1, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 1') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b <- aux %>% 
    mutate(test2 = ifelse(test2, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test2, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 2') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c <- aux %>% 
    mutate(test3 = ifelse(test3, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test3, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 3') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d <- aux %>% 
    mutate(test4 = ifelse(test4, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test4, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 4') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e <- aux %>% 
    mutate(test5 = ifelse(test5, 'Test', 'Training')) %>% 
    ggplot(aes(x = Week, y = `Clinical cases`, color = test5, group = 1)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ggtitle('Training-test split 5') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a / b / c / d / e
ggsave('./plots/SARS_train_test_split.pdf', device = 'pdf', height = 15, width = 10, dpi = 320)
```

## Todas las variables disponibles

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos1 <- completos
for (i in names(completos1)) {
    completos1[is.na(completos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos1)
#             mae <- ModelMetrics::mae(completos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos2 <- completos
for (i in names(completos2)) {
    completos2[is.na(completos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos2)
#             mae <- c(mae, ModelMetrics::mae(completos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos3 <- completos
for (i in names(completos3)) {
    completos3[is.na(completos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos3)
#             mae <- c(mae, ModelMetrics::mae(completos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos4 <- completos
for (i in names(completos4)) {
    completos4[is.na(completos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos4)
#             mae <- c(mae, ModelMetrics::mae(completos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completos5 <- completos
for (i in names(completos5)) {
    completos5[is.na(completos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completos5)
#             mae <- c(mae, ModelMetrics::mae(completos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

Se han buscado los mejores parámetros para el Random Forest para cada conjunto de entrenamiento con un Grid Search (básicamente probar todas las combinaciones posibles entre un rango dado) modificando nodesize de 1 a 10, mtry de 1 a 10 y ntree de 10 a 100 en incrementos de 10 y 200, 300, 500, 1000.

Significado de los parámetros:

-   nodesize: Tamaño mínimo de los nodos. Los árboles se construyen diviendiendo en grupos por la variable que sea consecutivamente hasta tener una profundidad determinada. Este parámetro fija el número mínimo de observaciones que tienen que tener esos grupos en los que se van separando los datos. Si una división crea grupos más pequeños que este parámetro, la división no se produce y ese nodo se convierte en nodo "terminal", por lo que este parámetro controla la profundidad de los árboles. Por ejemplo, nodesize = 1 indica que los árboles pueden crecer hasta que los nodos contengan una sola observación cada uno.

-   mtry: Es el número de variables que tiene el algoritmo para elegir cada vez que tiene que crear un nodo. Por ejemplo, mtry = 60 indica que cada vez que va a elegir una variable para hacer una división y separar las observaciones, tiene para elegir entre un conjunto aleatorio de 60 variables del total que haya (en este caso 181).

-   ntree: Es el número de árboles diferentes que va a generar. La predicción final es la clase más votada entre todos estos árboles (en este caso las clases son las diferentes muestras).

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfcom1 <- randomForest(x = completos1[!aux$test1, ] %>% select(-`Clinical cases`), y = completos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 19,  ntree = 20)
rfcom1

varImpPlot(rfcom1)

set.seed(42)
rfcom2 <- randomForest(x = completos2[!aux$test2, ] %>% select(-`Clinical cases`), y = completos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 19,  ntree = 20)
rfcom2

varImpPlot(rfcom2)

set.seed(42)
rfcom3 <- randomForest(x = completos3[!aux$test3, ] %>% select(-`Clinical cases`), y = completos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 19,  ntree = 20)
rfcom3

varImpPlot(rfcom3)

set.seed(42)
rfcom4 <- randomForest(x = completos4[!aux$test4, ] %>% select(-`Clinical cases`), y = completos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 19,  ntree = 20)
rfcom4

varImpPlot(rfcom4)

set.seed(42)
rfcom5 <- randomForest(x = completos5[!aux$test5, ] %>% select(-`Clinical cases`), y = completos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 19,  ntree = 20)
rfcom5

varImpPlot(rfcom5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_comp_1 <- predict(rfcom1, newdata = completos1)
res_comp_2 <- predict(rfcom2, newdata = completos2)
res_comp_3 <- predict(rfcom3, newdata = completos3)
res_comp_4 <- predict(rfcom4, newdata = completos4)
res_comp_5 <- predict(rfcom5, newdata = completos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomp <- ((importance(rfcom1)[, 'IncNodePurity'] * e1) + 
                (importance(rfcom2)[, 'IncNodePurity'] * e2) + 
                (importance(rfcom3)[, 'IncNodePurity'] * e3) + 
                (importance(rfcom4)[, 'IncNodePurity'] * e4) + 
                (importance(rfcom5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomp <- ((importance(rfcom1)[, '%IncMSE'] * e1) + 
                (importance(rfcom2)[, '%IncMSE'] * e2) + 
                (importance(rfcom3)[, '%IncMSE'] * e3) + 
                (importance(rfcom4)[, '%IncMSE'] * e4) + 
                (importance(rfcom5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomp), `Increase Node Purity` = inpcomp, aux = names(inpcomp) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomp), `% Increase MSE` = imscomp, aux = names(imscomp) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_comp.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
a <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comp_1, 
              `c) RF 2` = res_comp_2, 
              `d) RF 3` = res_comp_3, 
              `e) RF 4` = res_comp_4, 
              `f) RF 5` = res_comp_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

a
ggsave('./plots/SARS_res_comp.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comp <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comp_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comp_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comp_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comp_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comp_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comp_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comp_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comp_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comp_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comp_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comp <- res_comp %>% 
    rbind(c(Data = 'Training %OM', res_comp[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comp[2, -1] / mean(aux$`Clinical cases`))) 

res_comp %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizados %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados1 <- normalizados
for (i in names(normalizados1)) {
    normalizados1[is.na(normalizados1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados1)
#             mae <- ModelMetrics::mae(normalizados1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizados %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados2 <- normalizados
for (i in names(normalizados2)) {
    normalizados2[is.na(normalizados2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados2)
#             mae <- c(mae, ModelMetrics::mae(normalizados2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizados %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados3 <- normalizados
for (i in names(normalizados3)) {
    normalizados3[is.na(normalizados3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados3)
#             mae <- c(mae, ModelMetrics::mae(normalizados3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizados %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados4 <- normalizados
for (i in names(normalizados4)) {
    normalizados4[is.na(normalizados4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados4)
#             mae <- c(mae, ModelMetrics::mae(normalizados4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizados %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizados5 <- normalizados
for (i in names(normalizados5)) {
    normalizados5[is.na(normalizados5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizados5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizados5)
#             mae <- c(mae, ModelMetrics::mae(normalizados5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnorm1 <- randomForest(x = normalizados1[!aux$test1, ] %>% select(-`Clinical cases`), 
                        y = normalizados1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 4,  ntree = 10)
rfnorm1

varImpPlot(rfnorm1)

set.seed(42)
rfnorm2 <- randomForest(x = normalizados2[!aux$test2, ] %>% select(-`Clinical cases`), 
                        y = normalizados2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 4,  ntree = 10)
rfnorm2

varImpPlot(rfnorm2)

set.seed(42)
rfnorm3 <- randomForest(x = normalizados3[!aux$test3, ] %>% select(-`Clinical cases`), 
                        y = normalizados3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 4,  ntree = 10)
rfnorm3

varImpPlot(rfnorm3)

set.seed(42)
rfnorm4 <- randomForest(x = normalizados4[!aux$test4, ] %>% select(-`Clinical cases`), 
                        y = normalizados4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 4,  ntree = 10)
rfnorm4

varImpPlot(rfnorm4)

set.seed(42)
rfnorm5 <- randomForest(x = normalizados5[!aux$test5, ] %>% select(-`Clinical cases`), 
                        y = normalizados5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 4,  ntree = 10)
rfnorm5

varImpPlot(rfnorm5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_norm_1 <- predict(rfnorm1, newdata = normalizados1)
res_norm_2 <- predict(rfnorm2, newdata = normalizados2)
res_norm_3 <- predict(rfnorm3, newdata = normalizados3)
res_norm_4 <- predict(rfnorm4, newdata = normalizados4)
res_norm_5 <- predict(rfnorm5, newdata = normalizados5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnorm <- ((importance(rfnorm1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnorm2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnorm3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnorm4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnorm5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnorm <- ((importance(rfnorm1)[, '%IncMSE'] * e1) + 
                (importance(rfnorm2)[, '%IncMSE'] * e2) + 
                (importance(rfnorm3)[, '%IncMSE'] * e3) + 
                (importance(rfnorm4)[, '%IncMSE'] * e4) + 
                (importance(rfnorm5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnorm), `Increase Node Purity` = inpnorm, aux = names(inpnorm) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnorm), `% Increase MSE` = imsnorm, aux = names(imsnorm) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_norm.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
b <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_norm_1, 
              `c) RF 2` = res_norm_2, 
              `d) RF 3` = res_norm_3, 
              `e) RF 4` = res_norm_4, 
              `f) RF 5` = res_norm_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

b
ggsave('./plots/SARS_res_norm.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_norm <- data.frame(Data = c('Training', 'Test'), 
                       RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_norm_1[!aux$test1]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_norm_1[aux$test1])), 
                       RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_norm_2[!aux$test2]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_norm_2[aux$test2])), 
                       RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_norm_3[!aux$test3]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_norm_3[aux$test3])), 
                       RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_norm_4[!aux$test4]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_norm_4[aux$test4])), 
                       RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_norm_5[!aux$test5]), 
                               ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_norm_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_norm <- res_norm %>% 
    rbind(c(Data = 'Training %OM', res_norm[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_norm[2, -1] / mean(aux$`Clinical cases`))) 

res_norm %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag11 <- normalizadoslag1
for (i in names(normalizadoslag11)) {
    normalizadoslag11[is.na(normalizadoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag11)
#             mae <- ModelMetrics::mae(normalizadoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag12 <- normalizadoslag1
for (i in names(normalizadoslag12)) {
    normalizadoslag12[is.na(normalizadoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag12)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag13 <- normalizadoslag1
for (i in names(normalizadoslag13)) {
    normalizadoslag13[is.na(normalizadoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag13)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag14 <- normalizadoslag1
for (i in names(normalizadoslag14)) {
    normalizadoslag14[is.na(normalizadoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag14)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag15 <- normalizadoslag1
for (i in names(normalizadoslag15)) {
    normalizadoslag15[is.na(normalizadoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag15)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag11 <- randomForest(x = normalizadoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 7,  ntree = 20)
rfnormlag11

varImpPlot(rfnormlag11)

set.seed(42)
rfnormlag12 <- randomForest(x = normalizadoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 7,  ntree = 20)
rfnormlag12

varImpPlot(rfnormlag12)

set.seed(42)
rfnormlag13 <- randomForest(x = normalizadoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 7,  ntree = 20)
rfnormlag13

varImpPlot(rfnormlag13)

set.seed(42)
rfnormlag14 <- randomForest(x = normalizadoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 7,  ntree = 20)
rfnormlag14

varImpPlot(rfnormlag14)

set.seed(42)
rfnormlag15 <- randomForest(x = normalizadoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 7,  ntree = 20)
rfnormlag15

varImpPlot(rfnormlag15)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1_1 <- predict(rfnormlag11, newdata = normalizadoslag11)
res_normlag1_2 <- predict(rfnormlag12, newdata = normalizadoslag12)
res_normlag1_3 <- predict(rfnormlag13, newdata = normalizadoslag13)
res_normlag1_4 <- predict(rfnormlag14, newdata = normalizadoslag14)
res_normlag1_5 <- predict(rfnormlag15, newdata = normalizadoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1 <- ((importance(rfnormlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1 <- ((importance(rfnormlag11)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag12)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag13)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag14)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1), `Increase Node Purity` = inpnormlag1, aux = names(inpnormlag1) != 'SARS-CoV-2 (gc/L) (lag 1)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1), `% Increase MSE` = imsnormlag1, aux = names(imsnormlag1) != 'SARS-CoV-2 (gc/L) (lag 1)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_norm_lag1.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
c <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1_1, 
              `c) RF 2` = res_normlag1_2, 
              `d) RF 3` = res_normlag1_3, 
              `e) RF 4` = res_normlag1_4, 
              `f) RF 5` = res_normlag1_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

c
ggsave('./plots/SARS_res_norm_lag1.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1 <- res_normlag1 %>% 
    rbind(c(Data = 'Training %OM', res_normlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag1juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos1 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos1)) {
    normalizadoslag1juntos1[is.na(normalizadoslag1juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag1juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag1juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos2 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos2)) {
    normalizadoslag1juntos2[is.na(normalizadoslag1juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag1juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos3 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos3)) {
    normalizadoslag1juntos3[is.na(normalizadoslag1juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag1juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos4 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos4)) {
    normalizadoslag1juntos4[is.na(normalizadoslag1juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag1juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag1juntos5 <- normalizadoslag1juntos
for (i in names(normalizadoslag1juntos5)) {
    normalizadoslag1juntos5[is.na(normalizadoslag1juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag1juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag1juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag1juntos1 <- randomForest(x = normalizadoslag1juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 7,  ntree = 10)
rfnormlag1juntos1

varImpPlot(rfnormlag1juntos1)

set.seed(42)
rfnormlag1juntos2 <- randomForest(x = normalizadoslag1juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 7,  ntree = 10)
rfnormlag1juntos2

varImpPlot(rfnormlag1juntos2)

set.seed(42)
rfnormlag1juntos3 <- randomForest(x = normalizadoslag1juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 7,  ntree = 10)
rfnormlag1juntos3

varImpPlot(rfnormlag1juntos3)

set.seed(42)
rfnormlag1juntos4 <- randomForest(x = normalizadoslag1juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 7,  ntree = 10)
rfnormlag1juntos4

varImpPlot(rfnormlag1juntos4)

set.seed(42)
rfnormlag1juntos5 <- randomForest(x = normalizadoslag1juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag1juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 7,  ntree = 10)
rfnormlag1juntos5

varImpPlot(rfnormlag1juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag1juntos_1 <- predict(rfnormlag1juntos1, newdata = normalizadoslag1juntos1)
res_normlag1juntos_2 <- predict(rfnormlag1juntos2, newdata = normalizadoslag1juntos2)
res_normlag1juntos_3 <- predict(rfnormlag1juntos3, newdata = normalizadoslag1juntos3)
res_normlag1juntos_4 <- predict(rfnormlag1juntos4, newdata = normalizadoslag1juntos4)
res_normlag1juntos_5 <- predict(rfnormlag1juntos5, newdata = normalizadoslag1juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag1juntos <- ((importance(rfnormlag1juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag1juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag1juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag1juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag1juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag1juntos <- ((importance(rfnormlag1juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag1juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag1juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag1juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag1juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag1juntos), `Increase Node Purity` = inpnormlag1juntos, aux = names(inpnormlag1juntos) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag1juntos), `% Increase MSE` = imsnormlag1juntos, aux = names(imsnormlag1juntos) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_norm_lag1_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
d <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag1juntos_1, 
              `c) RF 2` = res_normlag1juntos_2, 
              `d) RF 3` = res_normlag1juntos_3, 
              `e) RF 4` = res_normlag1juntos_4, 
              `f) RF 5` = res_normlag1juntos_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 1 week lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

d
ggsave('./plots/SARS_res_norm_lag1_juntos.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag1juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag1juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag1juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag1juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag1juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag1juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag1juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag1juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag1juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag1juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag1juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag1juntos <- res_normlag1juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag1juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag1juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag1juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 semana anterior

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag11 <- completoslag1
for (i in names(completoslag11)) {
    completoslag11[is.na(completoslag11[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag11$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag11)
#             mae <- ModelMetrics::mae(completoslag11$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag12 <- completoslag1
for (i in names(completoslag12)) {
    completoslag12[is.na(completoslag12[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag12$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag12)
#             mae <- c(mae, ModelMetrics::mae(completoslag12$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag13 <- completoslag1
for (i in names(completoslag13)) {
    completoslag13[is.na(completoslag13[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag13$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag13)
#             mae <- c(mae, ModelMetrics::mae(completoslag13$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag14 <- completoslag1
for (i in names(completoslag14)) {
    completoslag14[is.na(completoslag14[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag14$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag14)
#             mae <- c(mae, ModelMetrics::mae(completoslag14$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag15 <- completoslag1
for (i in names(completoslag15)) {
    completoslag15[is.na(completoslag15[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag15$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag15)
#             mae <- c(mae, ModelMetrics::mae(completoslag15$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag11 <- randomForest(x = completoslag11[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag11$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 38,  ntree = 10)
rfcomlag11

varImpPlot(rfcomlag11)

set.seed(42)
rfcomlag12 <- randomForest(x = completoslag12[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag12$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 38,  ntree = 10)
rfcomlag12

varImpPlot(rfcomlag12)

set.seed(42)
rfcomlag13 <- randomForest(x = completoslag13[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag13$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 38,  ntree = 10)
rfcomlag13

varImpPlot(rfcomlag13)

set.seed(42)
rfcomlag14 <- randomForest(x = completoslag14[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag14$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 38,  ntree = 10)
rfcomlag14

varImpPlot(rfcomlag14)

set.seed(42)
rfcomlag15 <- randomForest(x = completoslag15[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag15$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 38,  ntree = 10)
rfcomlag15

varImpPlot(rfcomlag15)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag1_1 <- predict(rfcomlag11, newdata = completoslag11)
res_comlag1_2 <- predict(rfcomlag12, newdata = completoslag12)
res_comlag1_3 <- predict(rfcomlag13, newdata = completoslag13)
res_comlag1_4 <- predict(rfcomlag14, newdata = completoslag14)
res_comlag1_5 <- predict(rfcomlag15, newdata = completoslag15)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag1 <- ((importance(rfcomlag11)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag12)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag13)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag14)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag15)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag1 <- ((importance(rfcomlag11)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag12)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag13)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag14)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag15)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag1), `Increase Node Purity` = inpcomlag1, aux = names(inpcomlag1) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag1), `% Increase MSE` = imscomlag1, aux = names(imscomlag1) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_comp_lag1.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
e <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag1_1, 
              `c) RF 2` = res_comlag1_2, 
              `d) RF 3` = res_comlag1_3, 
              `e) RF 4` = res_comlag1_4, 
              `f) RF 5` = res_comlag1_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 week lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

e
ggsave('./plots/SARS_res_comp_lag1.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

```{r echo=FALSE}
res_comlag1 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag1_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag1_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag1_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag1_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag1_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag1_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag1_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag1_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag1_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag1_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag1 <- res_comlag1 %>% 
    rbind(c(Data = 'Training %OM', res_comlag1[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag1[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag1 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag21 <- normalizadoslag2
for (i in names(normalizadoslag21)) {
    normalizadoslag21[is.na(normalizadoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag21)
#             mae <- ModelMetrics::mae(normalizadoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag22 <- normalizadoslag2
for (i in names(normalizadoslag22)) {
    normalizadoslag22[is.na(normalizadoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag22)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag23 <- normalizadoslag2
for (i in names(normalizadoslag23)) {
    normalizadoslag23[is.na(normalizadoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag23)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag24 <- normalizadoslag2
for (i in names(normalizadoslag24)) {
    normalizadoslag24[is.na(normalizadoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag24)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag25 <- normalizadoslag2
for (i in names(normalizadoslag25)) {
    normalizadoslag25[is.na(normalizadoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag25)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag21 <- randomForest(x = normalizadoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 1,  ntree = 20)
rfnormlag21

varImpPlot(rfnormlag21)

set.seed(42)
rfnormlag22 <- randomForest(x = normalizadoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 1,  ntree = 20)
rfnormlag22

varImpPlot(rfnormlag22)

set.seed(42)
rfnormlag23 <- randomForest(x = normalizadoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 1,  ntree = 20)
rfnormlag23

varImpPlot(rfnormlag23)

set.seed(42)
rfnormlag24 <- randomForest(x = normalizadoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 1,  ntree = 20)
rfnormlag24

varImpPlot(rfnormlag24)

set.seed(42)
rfnormlag25 <- randomForest(x = normalizadoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                           y = normalizadoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 1,  ntree = 20)
rfnormlag25

varImpPlot(rfnormlag25)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2_1 <- predict(rfnormlag21, newdata = normalizadoslag21)
res_normlag2_2 <- predict(rfnormlag22, newdata = normalizadoslag22)
res_normlag2_3 <- predict(rfnormlag23, newdata = normalizadoslag23)
res_normlag2_4 <- predict(rfnormlag24, newdata = normalizadoslag24)
res_normlag2_5 <- predict(rfnormlag25, newdata = normalizadoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2 <- ((importance(rfnormlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2 <- ((importance(rfnormlag21)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag22)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag23)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag24)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2), `Increase Node Purity` = inpnormlag2, aux = names(inpnormlag2) != 'SARS-CoV-2 (gc/L) (lag 2)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2), `% Increase MSE` = imsnormlag2, aux = names(imsnormlag2) != 'SARS-CoV-2 (gc/L) (lag 2)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_norm_lag2.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
f <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2_1, 
              `c) RF 2` = res_normlag2_2, 
              `d) RF 3` = res_normlag2_3, 
              `e) RF 4` = res_normlag2_4, 
              `f) RF 5` = res_normlag2_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

f
ggsave('./plots/SARS_res_norm_lag2.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2 <- res_normlag2 %>% 
    rbind(c(Data = 'Training %OM', res_normlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Variables de niveles normalizados misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- normalizadoslag2juntos %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos1 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos1)) {
    normalizadoslag2juntos1[is.na(normalizadoslag2juntos1[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos1)
#             mae <- ModelMetrics::mae(normalizadoslag2juntos1$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- normalizadoslag2juntos %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos2 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos2)) {
    normalizadoslag2juntos2[is.na(normalizadoslag2juntos2[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos2)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos2$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- normalizadoslag2juntos %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos3 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos3)) {
    normalizadoslag2juntos3[is.na(normalizadoslag2juntos3[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos3)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos3$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- normalizadoslag2juntos %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos4 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos4)) {
    normalizadoslag2juntos4[is.na(normalizadoslag2juntos4[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos4)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos4$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- normalizadoslag2juntos %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

normalizadoslag2juntos5 <- normalizadoslag2juntos
for (i in names(normalizadoslag2juntos5)) {
    normalizadoslag2juntos5[is.na(normalizadoslag2juntos5[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = normalizadoslag2juntos5)
#             mae <- c(mae, ModelMetrics::mae(normalizadoslag2juntos5$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=6, fig.width=18}
set.seed(42)
rfnormlag2juntos1 <- randomForest(x = normalizadoslag2juntos1[!aux$test1, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos1$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 9,  ntree = 50)
rfnormlag2juntos1

varImpPlot(rfnormlag2juntos1)

set.seed(42)
rfnormlag2juntos2 <- randomForest(x = normalizadoslag2juntos2[!aux$test2, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos2$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 9,  ntree = 50)
rfnormlag2juntos2

varImpPlot(rfnormlag2juntos2)

set.seed(42)
rfnormlag2juntos3 <- randomForest(x = normalizadoslag2juntos3[!aux$test3, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos3$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 9,  ntree = 50)
rfnormlag2juntos3

varImpPlot(rfnormlag2juntos3)

set.seed(42)
rfnormlag2juntos4 <- randomForest(x = normalizadoslag2juntos4[!aux$test4, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos4$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 9,  ntree = 50)
rfnormlag2juntos4

varImpPlot(rfnormlag2juntos4)

set.seed(42)
rfnormlag2juntos5 <- randomForest(x = normalizadoslag2juntos5[!aux$test5, ] %>% select(-`Clinical cases`), 
                                 y = normalizadoslag2juntos5$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 9,  ntree = 50)
rfnormlag2juntos5

varImpPlot(rfnormlag2juntos5)
```

### Importancia

```{r echo=FALSE, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
res_normlag2juntos_1 <- predict(rfnormlag2juntos1, newdata = normalizadoslag2juntos1)
res_normlag2juntos_2 <- predict(rfnormlag2juntos2, newdata = normalizadoslag2juntos2)
res_normlag2juntos_3 <- predict(rfnormlag2juntos3, newdata = normalizadoslag2juntos3)
res_normlag2juntos_4 <- predict(rfnormlag2juntos4, newdata = normalizadoslag2juntos4)
res_normlag2juntos_5 <- predict(rfnormlag2juntos5, newdata = normalizadoslag2juntos5)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]) / mean(aux$`Clinical cases`)

inpnormlag2juntos <- ((importance(rfnormlag2juntos1)[, 'IncNodePurity'] * e1) + 
                (importance(rfnormlag2juntos2)[, 'IncNodePurity'] * e2) + 
                (importance(rfnormlag2juntos3)[, 'IncNodePurity'] * e3) + 
                (importance(rfnormlag2juntos4)[, 'IncNodePurity'] * e4) + 
                (importance(rfnormlag2juntos5)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imsnormlag2juntos <- ((importance(rfnormlag2juntos1)[, '%IncMSE'] * e1) + 
                (importance(rfnormlag2juntos2)[, '%IncMSE'] * e2) + 
                (importance(rfnormlag2juntos3)[, '%IncMSE'] * e3) + 
                (importance(rfnormlag2juntos4)[, '%IncMSE'] * e4) + 
                (importance(rfnormlag2juntos5)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpnormlag2juntos), `Increase Node Purity` = inpnormlag2juntos, aux = names(inpnormlag2juntos) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imsnormlag2juntos), `% Increase MSE` = imsnormlag2juntos, aux = names(imsnormlag2juntos) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_norm_lag2_juntos.pdf', device = 'pdf', height = 5, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
g <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_normlag2juntos_1, 
              `c) RF 2` = res_normlag2juntos_2, 
              `d) RF 3` = res_normlag2juntos_3, 
              `e) RF 4` = res_normlag2juntos_4, 
              `f) RF 5` = res_normlag2juntos_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Normalised 2 weeks lagged and normalised level') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

g
ggsave('./plots/SARS_res_norm_lag2_juntos.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_normlag2juntos <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_normlag2juntos_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_normlag2juntos_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_normlag2juntos_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_normlag2juntos_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_normlag2juntos_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_normlag2juntos_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_normlag2juntos_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_normlag2juntos_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_normlag2juntos_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_normlag2juntos_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_normlag2juntos <- res_normlag2juntos %>% 
    rbind(c(Data = 'Training %OM', res_normlag2juntos[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_normlag2juntos[2, -1] / mean(aux$`Clinical cases`))) 

res_normlag2juntos %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag21 <- completoslag2
for (i in names(completoslag21)) {
    completoslag21[is.na(completoslag21[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag21$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag21)
#             mae <- ModelMetrics::mae(completoslag21$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag22 <- completoslag2
for (i in names(completoslag22)) {
    completoslag22[is.na(completoslag22[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag22$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag22)
#             mae <- c(mae, ModelMetrics::mae(completoslag22$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag23 <- completoslag2
for (i in names(completoslag23)) {
    completoslag23[is.na(completoslag23[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag23$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag23)
#             mae <- c(mae, ModelMetrics::mae(completoslag23$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag24 <- completoslag2
for (i in names(completoslag24)) {
    completoslag24[is.na(completoslag24[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag24$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag24)
#             mae <- c(mae, ModelMetrics::mae(completoslag24$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag25 <- completoslag2
for (i in names(completoslag25)) {
    completoslag25[is.na(completoslag25[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag25$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag25)
#             mae <- c(mae, ModelMetrics::mae(completoslag25$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag21 <- randomForest(x = completoslag21[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag21$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 27,  ntree = 10)
rfcomlag21

varImpPlot(rfcomlag21)

set.seed(42)
rfcomlag22 <- randomForest(x = completoslag22[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag22$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 27,  ntree = 10)
rfcomlag22

varImpPlot(rfcomlag22)

set.seed(42)
rfcomlag23 <- randomForest(x = completoslag23[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag23$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 27,  ntree = 10)
rfcomlag23

varImpPlot(rfcomlag23)

set.seed(42)
rfcomlag24 <- randomForest(x = completoslag24[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag24$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 27,  ntree = 10)
rfcomlag24

varImpPlot(rfcomlag24)

set.seed(42)
rfcomlag25 <- randomForest(x = completoslag25[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag25$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 27,  ntree = 10)
rfcomlag25

varImpPlot(rfcomlag25)
```

### Importancia

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
res_comlag2_1 <- predict(rfcomlag21, newdata = completoslag21)
res_comlag2_2 <- predict(rfcomlag22, newdata = completoslag22)
res_comlag2_3 <- predict(rfcomlag23, newdata = completoslag23)
res_comlag2_4 <- predict(rfcomlag24, newdata = completoslag24)
res_comlag2_5 <- predict(rfcomlag25, newdata = completoslag25)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag2 <- ((importance(rfcomlag21)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag22)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag23)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag24)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag25)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag2 <- ((importance(rfcomlag21)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag22)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag23)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag24)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag25)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag2), `Increase Node Purity` = inpcomlag2, aux = names(inpcomlag2) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = f) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag2), `% Increase MSE` = imscomlag2, aux = names(imscomlag2) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_comp_lag2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
h <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag2_1, 
              `c) RF 2` = res_comlag2_2, 
              `d) RF 3` = res_comlag2_3, 
              `e) RF 4` = res_comlag2_4, 
              `f) RF 5` = res_comlag2_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

h
ggsave('./plots/SARS_res_comp_lag2.pdf', device = 'pdf', height = 6, width = 12, dpi = 320)
```

```{r echo=FALSE}
res_comlag2 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag2_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag2_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag2_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag2_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag2_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag2_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag2_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag2_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag2_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag2_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag2 <- res_comlag2 %>% 
    rbind(c(Data = 'Training %OM', res_comlag2[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag2[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag2 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Todas las variables disponibles misma semana y 1 y 2 semanas antes

```{r echo=FALSE}
#-------------------------------------------------------------------------------
# conjunto 1
aux_train <- completoslag1y2 %>% filter(!aux$test1)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag121 <- completoslag1y2
for (i in names(completoslag121)) {
    completoslag121[is.na(completoslag121[i]), i] <- medianas[i]
}

# set.seed(42)
# res <- data.frame(nodesize = 0, mtry = 0, ntree = 0, mae = 0)
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag121$`Clinical cases`[!aux$test1], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag121)
#             mae <- ModelMetrics::mae(completoslag121$`Clinical cases`, preds)
#             res <- rbind(res, c(ns, mt, nt, mae))
#         }
#     }
# }
# res <- res[-1, ]
#-------------------------------------------------------------------------------
# conjunto 2
aux_train <- completoslag1y2 %>% filter(!aux$test2)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag122 <- completoslag1y2
for (i in names(completoslag122)) {
    completoslag122[is.na(completoslag122[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag122$`Clinical cases`[!aux$test2], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag122)
#             mae <- c(mae, ModelMetrics::mae(completoslag122$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 3
aux_train <- completoslag1y2 %>% filter(!aux$test3)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag123 <- completoslag1y2
for (i in names(completoslag123)) {
    completoslag123[is.na(completoslag123[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag123$`Clinical cases`[!aux$test3], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag123)
#             mae <- c(mae, ModelMetrics::mae(completoslag123$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 4
aux_train <- completoslag1y2 %>% filter(!aux$test4)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag124 <- completoslag1y2
for (i in names(completoslag124)) {
    completoslag124[is.na(completoslag124[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag124$`Clinical cases`[!aux$test4], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag124)
#             mae <- c(mae, ModelMetrics::mae(completoslag124$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
#-------------------------------------------------------------------------------
# conjunto 5
aux_train <- completoslag1y2 %>% filter(!aux$test5)

medias <- aux_train %>% summarise_all(mean, na.rm = T)
medianas <- aux_train %>% summarise_all(median, na.rm = T)
stds <- aux_train %>% summarise_all(sd, na.rm = T)

completoslag125 <- completoslag1y2
for (i in names(completoslag125)) {
    completoslag125[is.na(completoslag125[i]), i] <- medianas[i]
}

# set.seed(42)
# mae <- c()
# for (ns in 1:10) {
#     for (mt in 1:(length(names(aux_train))-1)) {
#         for (nt in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 500, 1000)) {
#             set.seed(42)
#             rfres <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
#                                   y = completoslag125$`Clinical cases`[!aux$test5], 
#                                   importance = T, 
#                                   nodesize = ns, 
#                                   mtry = mt,  
#                                   ntree = nt)
#             preds <- predict(rfres, newdata = completoslag125)
#             mae <- c(mae, ModelMetrics::mae(completoslag125$`Clinical cases`, preds))
#         }
#     }
# }
# res$mae <- res$mae + mae
# plot(res$mae)
# res[which.min(res$mae), ]
```

```{r echo=FALSE, fig.height=7, fig.width=18}
set.seed(42)
rfcomlag121 <- randomForest(x = completoslag121[!aux$test1, ] %>% select(-`Clinical cases`), 
                          y = completoslag121$`Clinical cases`[!aux$test1], importance = T, nodesize = 1, mtry = 20,  ntree = 10)
rfcomlag121

varImpPlot(rfcomlag121)

set.seed(42)
rfcomlag122 <- randomForest(x = completoslag122[!aux$test2, ] %>% select(-`Clinical cases`), 
                          y = completoslag122$`Clinical cases`[!aux$test2], importance = T, nodesize = 1, mtry = 20,  ntree = 10)
rfcomlag122

varImpPlot(rfcomlag122)

set.seed(42)
rfcomlag123 <- randomForest(x = completoslag123[!aux$test3, ] %>% select(-`Clinical cases`), 
                          y = completoslag123$`Clinical cases`[!aux$test3], importance = T, nodesize = 1, mtry = 20,  ntree = 10)
rfcomlag123

varImpPlot(rfcomlag123)

set.seed(42)
rfcomlag124 <- randomForest(x = completoslag124[!aux$test4, ] %>% select(-`Clinical cases`), 
                          y = completoslag124$`Clinical cases`[!aux$test4], importance = T, nodesize = 1, mtry = 20,  ntree = 10)
rfcomlag124

varImpPlot(rfcomlag124)

set.seed(42)
rfcomlag125 <- randomForest(x = completoslag125[!aux$test5, ] %>% select(-`Clinical cases`), 
                          y = completoslag125$`Clinical cases`[!aux$test5], importance = T, nodesize = 1, mtry = 20,  ntree = 10)
rfcomlag125

varImpPlot(rfcomlag125)
```

### Importancia

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
res_comlag12_1 <- predict(rfcomlag121, newdata = completoslag121)
res_comlag12_2 <- predict(rfcomlag122, newdata = completoslag122)
res_comlag12_3 <- predict(rfcomlag123, newdata = completoslag123)
res_comlag12_4 <- predict(rfcomlag124, newdata = completoslag124)
res_comlag12_5 <- predict(rfcomlag125, newdata = completoslag125)

e1 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1]) / mean(aux$`Clinical cases`)
e2 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2]) / mean(aux$`Clinical cases`)
e3 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3]) / mean(aux$`Clinical cases`)
e4 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4]) / mean(aux$`Clinical cases`)
e5 <- 1 - ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]) / mean(aux$`Clinical cases`)

inpcomlag12 <- ((importance(rfcomlag121)[, 'IncNodePurity'] * e1) + 
                (importance(rfcomlag122)[, 'IncNodePurity'] * e2) + 
                (importance(rfcomlag123)[, 'IncNodePurity'] * e3) + 
                (importance(rfcomlag124)[, 'IncNodePurity'] * e4) + 
                (importance(rfcomlag125)[, 'IncNodePurity'] * e5)) / (e1 + e2 + e3 + e4 + e5)
imscomlag12 <- ((importance(rfcomlag121)[, '%IncMSE'] * e1) + 
                (importance(rfcomlag122)[, '%IncMSE'] * e2) + 
                (importance(rfcomlag123)[, '%IncMSE'] * e3) + 
                (importance(rfcomlag124)[, '%IncMSE'] * e4) + 
                (importance(rfcomlag125)[, '%IncMSE'] * e5)) / (e1 + e2 + e3 + e4 + e5)

(ggplot(data.frame(Variable = names(inpcomlag12), `Increase Node Purity` = inpcomlag12, aux = names(inpcomlag12) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(imscomlag12), `% Increase MSE` = imscomlag12, aux = names(imscomlag12) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_comp_lag12.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```

### Resultados

```{r echo=FALSE, fig.height=3, fig.width=10}
i <- aux %>% 
    select(`Clinical cases`, test1) %>% 
    transmute(`a) Clinical cases` = `Clinical cases`, 
              `b) RF 1` = res_comlag12_1, 
              `c) RF 2` = res_comlag12_2, 
              `d) RF 3` = res_comlag12_3, 
              `e) RF 4` = res_comlag12_4, 
              `f) RF 5` = res_comlag12_5, 
              Week = aux$Week, 
              test1 = ifelse(test1, 'Test', 'Training')) %>% 
    pivot_longer(-c(Week, test1)) %>% 
    ggplot(aes(x = Week, y = value, color = name, group = name)) + 
    geom_line(alpha = 0.7) + 
    geom_point(alpha = 0.7, size = 1) + 
    ylab('Clinical cases') + 
    ggtitle('Random Forests\' predictions on training and test data', subtitle = 'Complete 1 & 2 weeks lagged and complete data') + 
    theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))

i
ggsave('./plots/SARS_res_comp_lag12.pdf', device = 'pdf', height = 3, width = 10, dpi = 320)
```

```{r echo=FALSE}
res_comlag12 <- data.frame(Data = c('Training', 'Test'), 
                          RF1 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test1], res_comlag12_1[!aux$test1]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test1], res_comlag12_1[aux$test1])), 
                          RF2 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test2], res_comlag12_2[!aux$test2]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test2], res_comlag12_2[aux$test2])), 
                          RF3 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test3], res_comlag12_3[!aux$test3]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test3], res_comlag12_3[aux$test3])), 
                          RF4 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test4], res_comlag12_4[!aux$test4]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test4], res_comlag12_4[aux$test4])), 
                          RF5 = c(ModelMetrics::mae(aux$`Clinical cases`[!aux$test5], res_comlag12_5[!aux$test5]), 
                                  ModelMetrics::mae(aux$`Clinical cases`[aux$test5], res_comlag12_5[aux$test5]))) %>% 
    mutate(Mean = (RF1 + RF2 + RF3 + RF4 + RF5) / 5)

res_comlag12 <- res_comlag12 %>% 
    rbind(c(Data = 'Training %OM', res_comlag12[1, -1] / mean(aux$`Clinical cases`))) %>% 
    rbind(c(Data = 'Test %OM', res_comlag12[2, -1] / mean(aux$`Clinical cases`))) 

res_comlag12 %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

## Resumen

```{r echo=FALSE, fig.height=27, fig.width=10, message=FALSE, warning=FALSE}
a / b / c / d / e / f / g / h / i
ggsave('./plots/SARS_res_final.pdf', device = 'pdf', height = 27, width = 10, dpi = 320)
```

```{r echo=FALSE}
data.frame(Set = res_comp[, 1], 
           Complete = res_comp[, 7], 
           Normalised = res_norm[, 7], 
           `Normalised 1w lagged` = res_normlag1[, 7], 
           `Normalised and 1w lagged` = res_normlag1juntos[, 7], 
           `Complete and 1w lagged` = res_comlag1[, 7], 
           `Normalised 2w lagged` = res_normlag2[, 7], 
           `Normalised and 2w lagged` = res_normlag2juntos[, 7], 
           `Complete and 2w lagged` = res_comlag2[, 7], 
           `Complete, 1w & 2w lagged` = res_comlag12[, 7], 
           check.names = F) %>%
    reactable(searchable = TRUE, 
              striped = TRUE, 
              highlight = TRUE, 
              bordered = TRUE, 
              defaultColDef = colDef(format = colFormat(digits = 3)), 
              theme = reactableTheme(borderColor = "#dfe2e5", 
                                     stripedColor = "#f6f8fa", 
                                     highlightColor = "#f0f5f9", 
                                     style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"), 
                                     searchInputStyle = list(width = "100%")))
```

```{r echo=FALSE, fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
inp <- inpcomlag12 * (1 - mean(res_comlag12[3:4, 7]))
ims <- imscomlag12 * (1 - mean(res_comlag12[3:4, 7]))

for (n in names(inp)) {
    auxi <- 0
    if (n %in% names(inpcomp)) {
        auxi <- auxi + (1 - mean(res_comp[3:4, 7]))
        inp[n] <- inp[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
        ims[n] <- ims[n] + inpcomp[n] * (1 - mean(res_comp[3:4, 7]))
    }
    if (n %in% names(inpnorm)) {
        auxi <- auxi + (1 - mean(res_norm[3:4, 7]))
        inp[n] <- inp[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
        ims[n] <- ims[n] + inpnorm[n] * (1 - mean(res_norm[3:4, 7]))
    }
    if (n %in% names(inpnormlag1)) {
        auxi <- auxi + (1 - mean(res_normlag1[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1[n] * (1 - mean(res_normlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag1juntos)) {
        auxi <- auxi + (1 - mean(res_normlag1juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag1juntos[n] * (1 - mean(res_normlag1juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag1)) {
        auxi <- auxi + (1 - mean(res_comlag1[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag1[n] * (1 - mean(res_comlag1[3:4, 7]))
    }
    if (n %in% names(inpnormlag2)) {
        auxi <- auxi + (1 - mean(res_normlag2[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2[n] * (1 - mean(res_normlag2[3:4, 7]))
    }
    if (n %in% names(inpnormlag2juntos)) {
        auxi <- auxi + (1 - mean(res_normlag2juntos[3:4, 7]))
        inp[n] <- inp[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
        ims[n] <- ims[n] + inpnormlag2juntos[n] * (1 - mean(res_normlag2juntos[3:4, 7]))
    }
    if (n %in% names(inpcomlag2)) {
        auxi <- auxi + (1 - mean(res_comlag2[3:4, 7]))
        inp[n] <- inp[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
        ims[n] <- ims[n] + inpcomlag2[n] * (1 - mean(res_comlag2[3:4, 7]))
    }
    if (n %in% names(inpcomlag12)) {
        auxi <- auxi + (1 - mean(res_comlag12[3:4, 7]))
    }
    inp[n] <- inp[n] / auxi
    ims[n] <- ims[n] / auxi
}

(ggplot(data.frame(Variable = names(inp), `Increase Node Purity` = inp, aux = names(inp) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
        geom_col(aes(y = reorder(Variable, `Increase Node Purity`), x = `Increase Node Purity`, fill = aux), show.legend = F) + 
        ylab('')) +
    (ggplot(data.frame(Variable = names(ims), `% Increase MSE` = ims, aux = names(ims) != 'SARS-CoV-2 (gc/L)', check.names = F)) + 
         geom_col(aes(y = reorder(Variable, `% Increase MSE`), x = `% Increase MSE`, fill = aux), show.legend = F) + 
         ylab(''))
ggsave('./plots/SARS_imp_final.pdf', device = 'pdf', height = 9, width = 12, dpi = 320)
```


